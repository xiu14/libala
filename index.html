<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ‘‚ğŸ»é»å§å•¦aiç«™ğŸ‘‚ğŸ»</title>
    <style>
        /* åŸºç¡€å˜é‡ */
        :root { 
            --bg-color: #f8fafe; --chat-bg: #ffffff; --sidebar-bg: #ffffff; 
            --text-color: #333333; --border-color: #ebedf0; 
            --primary-color: #4f46e5; --my-msg-bg: #4f46e5; --my-msg-text: #ffffff; 
            --ai-msg-bg: #f3f4f6; --ai-msg-text: #1f2937; --token-text: #9ca3af; 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
            --transition: transform 0.3s ease;
        }
        [data-theme="dark"] { 
            --bg-color: #111827; --chat-bg: #1f2937; --sidebar-bg: #1f2937; 
            --text-color: #f3f4f6; --border-color: #374151; 
            --primary-color: #6366f1; --my-msg-bg: #6366f1; --my-msg-text: #ffffff; 
            --ai-msg-bg: #374151; --ai-msg-text: #f3f4f6; --token-text: #9ca3af; 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; position: fixed; width: 100%; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; }
        .login-box { background: var(--chat-bg); padding: 40px; border-radius: 20px; box-shadow: var(--shadow); width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--border-color); }
        .login-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--primary-color); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; outline:none; background: var(--bg-color); color: var(--text-color); }
        .login-btn { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .reset-link { margin-top: 15px; font-size: 12px; color: var(--token-text); text-decoration: underline; cursor: pointer; }

        /* Main App */
        .app-container { display: none; height: 100%; position: relative; max-width: 1200px; margin: 0 auto; background: var(--chat-bg); box-shadow: var(--shadow); }
        @media (min-width: 1201px) { .app-container { height: 95vh; margin-top: 2.5vh; border-radius: 16px; overflow: hidden; } }
        
        /* Sidebar */
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 280px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; gap: 15px; transform: translateX(-100%); transition: var(--transition); z-index: 50; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .sidebar.open { transform: translateX(0); }
        .overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 40; }
        .overlay.show { display: block; }
        
        .mode-list { display: flex; flex-direction: column; gap: 10px; max-height: 40%; overflow-y: auto; }
        .mode-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; background: var(--bg-color); border: 2px solid transparent; cursor: pointer; transition: none; flex-shrink: 0;}
        .mode-card.selected { border-color: var(--primary-color); background: rgba(79, 70, 229, 0.05); }
        .mode-icon { font-size: 22px; }
        .mode-info div:first-child { font-weight: 600; font-size: 14px; }
        .mode-info div:last-child { font-size: 12px; color: var(--token-text); }
        
        .session-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .session-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: space-between; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .session-item.active { background: rgba(79, 70, 229, 0.1); color: var(--primary-color); font-weight: 600; }
        .session-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; margin-right: 8px;}

        /* Admin Button */
        #adminBtn { display: none; background: #1f2937; color: white; margin-bottom: 10px; }
        
        /* Chat Area */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; width: 100%; }
        .chat-header { padding: 0 20px; height: 60px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background-color: var(--chat-bg); z-index: 10; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: auto; -webkit-overflow-scrolling: touch; }
        
        .message { max-width: 85%; display: flex; flex-direction: column; gap: 4px; }
        .user-msg { align-self: flex-end; align-items: flex-end; }
        .ai-msg { align-self: flex-start; align-items: flex-start; }
        .message-content { padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.6; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; overflow-wrap: break-word;}
        .user-msg .message-content { background: var(--my-msg-bg); color: var(--my-msg-text); border-bottom-right-radius: 4px; }
        .ai-msg .message-content { background: var(--ai-msg-bg); color: var(--ai-msg-text); border-bottom-left-radius: 4px; }
        .message img { max-width: 200px; max-height: 200px; width: auto; height: auto; border-radius: 8px; margin-top: 8px; display: block; object-fit: cover; border: 1px solid #eee; }
        .message pre { margin: 0; white-space: pre-wrap; font-family: inherit; overflow-x: auto; }

        .input-wrapper { padding: 15px 20px; background: var(--chat-bg); width: 100%; padding-bottom: max(15px, env(safe-area-inset-bottom)); border-top: 1px solid var(--border-color); }
        .input-container { display: flex; align-items: flex-end; gap: 8px; background: var(--bg-color); padding: 8px 10px; border-radius: 16px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; }
        textarea { flex: 1; width: 0; min-width: 0; background: transparent; border: none; outline: none; resize: none; color: var(--text-color); font-size: 16px; max-height: 120px; font-family: inherit; padding: 8px 0; line-height: 1.4; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; background: transparent; color: var(--token-text); font-size: 20px; display:flex; align-items:center; justify-content:center; flex-shrink: 0; margin-bottom: 2px; }
        .send-btn { background: var(--primary-color); color: white; border-radius: 12px; width: 40px; height: 40px; font-size: 16px; }

        /* Preview Area */
        #preview-area { display:flex; gap:10px; padding-bottom:10px; overflow-x: auto; }
        .preview-item { position: relative; flex-shrink: 0; width: 60px; height: 60px;}
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid var(--border-color); }
        .preview-remove { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; }

        /* Admin Modal */
        #adminModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .admin-panel { background: var(--bg-color); width: 90%; max-width: 500px; max-height: 80vh; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); color: var(--text-color); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .admin-body { flex: 1; overflow-y: auto; }
        .admin-section { margin-bottom: 20px; }
        .stat-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .stat-table th, .stat-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .form-group input { padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--chat-bg); color: var(--text-color); }
        
        /* æŠ˜å é¢æ¿æ ·å¼ */
        .collapse-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--primary-color); }
        .collapse-content { display: none; padding: 5px; }
        .collapse-content.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .chat-header { padding: 0 15px; height: 54px; }
            #chat-box { padding: 15px; }
            .input-wrapper { padding: 10px 12px; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
            .sidebar { width: 80%; max-width: 300px; }
        }
    </style>
</head>
<body>
<div id="login-screen">
    <div class="login-box">
        <div class="login-title">ğŸ‘‚ğŸ»é»å§å•¦aiç«™ğŸ‘‚ğŸ»</div>
        <input type="text" id="loginUser" class="login-input" placeholder="ç™»å½•å">
        <input type="password" id="loginPass" class="login-input" placeholder="å¯†ç ">
        <button class="login-btn" onclick="handleLogin()">è¿›å…¥ AI ç©ºé—´</button>
        <div id="loginError" style="color:red; margin-top:10px; display:none;">è´¦å·æˆ–å¯†ç é”™è¯¯</div>
        <div class="reset-link" onclick="emergencyReset()">APP æ€»æ˜¯é—ªé€€ï¼Ÿç‚¹å‡»é‡ç½®ç¼“å­˜</div>
    </div>
</div>

<div id="adminModal">
    <div class="admin-panel">
        <div class="admin-header">
            <h3 style="margin:0">âš™ï¸ ç®¡ç†åå°</h3>
            <button onclick="document.getElementById('adminModal').style.display='none'" style="border:none;background:none;font-size:20px;cursor:pointer;">âœ•</button>
        </div>
        <div class="admin-body">
            <div class="admin-section">
                <h4>ğŸ“Š ç»Ÿè®¡æ•°æ®</h4>
                <table class="stat-table" id="statTable">
                    <thead><tr><th>ç”¨æˆ·</th><th>æ¨¡å‹</th><th>æ¬¡æ•°</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="admin-section">
                <!-- æŠ˜å åŠŸèƒ½ -->
                <div class="collapse-header" onclick="toggleCollapse('addPresetForm')">
                    <span>â• æ·»åŠ æ–°æ¨¡å‹</span>
                    <span id="arrow-addPresetForm">â–¼</span>
                </div>
                <div class="collapse-content" id="addPresetForm">
                    <div class="form-group"><input type="text" id="addName" placeholder="æ˜¾ç¤ºåç§° (ä¾‹å¦‚: DeepSeek-V3)"></div>
                    <div class="form-group"><input type="text" id="addDesc" placeholder="å‰¯æ ‡é¢˜ (ä¾‹å¦‚: æ·±åº¦æ€è€ƒç‰ˆ)"></div>
                    <div class="form-group"><input type="text" id="addUrl" placeholder="API Base URL (ä¾‹å¦‚: https://api.deepseek.com)"></div>
                    <div class="form-group"><input type="text" id="addKey" placeholder="API Key (sk-...)"></div>
                    <div class="form-group"><input type="text" id="addModelId" placeholder="Model ID (API å®é™…è°ƒç”¨ID, å¦‚ deepseek-chat)"></div>
                    <button class="login-btn" onclick="addPreset()">ä¿å­˜å¹¶æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="app-container" id="app">
    <div class="overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <h3>âœ¨ é€‰æ‹©æ¨¡å‹</h3>
        <button id="adminBtn" class="mode-card" onclick="openAdmin()" style="justify-content:center;">âš™ï¸ ç®¡ç†åå°</button>
        <div class="mode-list" id="presetList"></div>
        <hr style="width:100%; border:0; border-top:1px solid var(--border-color); margin: 15px 0;">
        <h3>ğŸ—‚ï¸ åˆ‡æ¢çª—å£</h3>
        <div class="session-list" id="sessionList"></div>
        <button class="btn btn-logout" onclick="logout()" style="width:100%; padding:10px; border:none; border-radius:8px; cursor:pointer; font-size:13px; margin-top:5px; background:#fee2e2; color:#ef4444;">é€€å‡ºç™»å½•</button>
    </div>

    <div class="main-chat">
        <header class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="menu-btn" onclick="toggleSidebar()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:5px; color:var(--text-color);">â‰¡</button>
                <div style="font-weight:700; font-size:16px;"><span style="width:8px; height:8px; background:#10b981; border-radius:50%; display:inline-block; margin-right:8px;"></span><span id="headerTitle">AI Chat</span></div>
            </div>
            <button class="action-btn" onclick="toggleTheme()" style="width:30px; height:30px;">ğŸŒ—</button>
        </header>
        <div id="chat-box"></div>
        <div class="input-wrapper">
            <div id="preview-area"></div>
            <div class="input-container">
                <input type="file" id="fileInput" accept="image/*" multiple style="display:none;" onchange="handleFileSelect(this)">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</button>
                <textarea id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="action-btn send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>
</div>

<script>
    let PRESETS = [];
    let sessions = [];
    let currentSessionId = null;
    let isRequesting = false;
    let currentImages = [];
    let authToken = localStorage.getItem('authToken');
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    function emergencyReset() {
        if(confirm('è¿™ä¼šæ¸…é™¤æœ¬åœ°ç™»å½•çŠ¶æ€å¹¶åˆ·æ–°ï¼Œç¡®è®¤é‡ç½®å—ï¼Ÿ')) {
            localStorage.clear();
            location.reload();
        }
    }

    window.onload = function() {
        if (authToken) initApp();
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
    };

    async function handleLogin() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        if(!u || !p) return;
        const btn = document.querySelector('.login-btn');
        btn.disabled = true; btn.innerText = "éªŒè¯ä¸­...";
        try {
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p }) });
            const data = await res.json();
            if (data.success) {
                authToken = data.token;
                isAdmin = data.isAdmin;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('isAdmin', isAdmin);
                initApp();
            } else { 
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').innerText = data.message;
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        finally { btn.disabled = false; btn.innerText = "è¿›å…¥ AI ç©ºé—´"; }
    }

    function logout() { localStorage.clear(); location.reload(); }

    async function initApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        if(isAdmin) document.getElementById('adminBtn').style.display = 'flex';
        await fetchPresets();
        await fetchHistory();
    }

    async function fetchPresets() {
        try {
            const res = await fetch('/api/config');
            const data = await res.json();
            PRESETS = data.presets || [];
            renderPresets();
        } catch(e) { console.error("Config load failed"); }
    }

    function renderPresets() {
        const list = document.getElementById('presetList');
        list.innerHTML = '';
        PRESETS.forEach(p => {
            const div = document.createElement('div');
            div.className = 'mode-card';
            if (sessions.length > 0 && currentSessionId) {
                const currentS = sessions.find(s => s.id === currentSessionId);
                if (currentS && currentS.mode === p.id) div.classList.add('selected');
            }
            
            div.onclick = () => {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                startNewSession(p.id);
            };
            
            // ä¿®å¤æ¨¡å‹åç§°æ˜¾ç¤ºï¼šä¼˜å…ˆæ˜¾ç¤º p.nameï¼Œå¦‚æœä¸ºç©ºæ˜¾ç¤º p.id
            const displayName = p.name || p.id || "æœªå‘½åæ¨¡å‹";
            const displayDesc = p.desc || "AI Assistant";

            div.innerHTML = `<div class="mode-icon">${p.icon || 'ğŸ¤–'}</div><div class="mode-info"><div>${displayName}</div><div>${displayDesc}</div></div>`;
            list.appendChild(div);
        });
    }

    async function fetchHistory() {
        try {
            const res = await fetch('/api/history', { headers: { 'Authorization': `Bearer ${authToken}` } });
            const d = await res.json();
            if (d.success && Array.isArray(d.data) && d.data.length > 0) {
                sessions = d.data;
                if (sessions.length > 5) sessions = sessions.slice(0, 5); 
                renderSessionList();
                loadSession(sessions[0].id);
            } else {
                if(PRESETS.length > 0) startNewSession(PRESETS[0].id);
            }
        } catch (e) { 
            if(PRESETS.length > 0) startNewSession(PRESETS[0].id);
        }
    }

    async function saveHistory() {
        try {
            await fetch('/api/history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ sessions: sessions })
            });
        } catch(e) { }
    }

    function startNewSession(presetId) {
        const p = PRESETS.find(x => x.id === presetId) || PRESETS[0];
        const pName = p ? (p.name || p.id) : "AI";
        const newSession = { id: Date.now(), mode: presetId, name: `${pName} #${sessions.length + 1}`, messages: [], tokens: 0 };
        sessions.unshift(newSession);
        if (sessions.length > 10) sessions.pop();
        saveHistory();
        loadSession(newSession.id);
        if(window.innerWidth < 1000) toggleSidebar();
        renderPresets(); // æ›´æ–°é€‰ä¸­çŠ¶æ€
    }

    function loadSession(id) {
        currentSessionId = id;
        const session = sessions.find(s => s.id === id);
        if (!session) return;
        
        const box = document.getElementById('chat-box');
        box.innerHTML = ''; 

        if (session.messages.length === 0) {
            appendUI(null, "ai", `ğŸ‘‹ å·²åˆ›å»ºæ–°çª—å£ (${session.name})`);
        } else {
            const msgsToRender = session.messages.slice(-50);
            msgsToRender.forEach(msg => {
                if (Array.isArray(msg.content)) {
                    let txt = msg.content.find(c => c.type === 'text')?.text || '';
                    let imgs = msg.content.filter(c => c.type === 'image_url').map(c => c.image_url.url);
                    appendUI(null, msg.role === 'user' ? 'user' : 'ai', txt, imgs);
                } else {
                    appendUI(null, msg.role === 'user' ? 'user' : 'ai', msg.content);
                }
            });
            setTimeout(() => box.scrollTop = box.scrollHeight, 100);
        }
        
        document.getElementById('headerTitle').innerText = session.name;
        renderSessionList();
        renderPresets(); // æ›´æ–° Sidebar é€‰ä¸­æ€
    }

    function renderSessionList() {
        const list = document.getElementById('sessionList');
        list.innerHTML = '';
        sessions.forEach(s => {
            const p = PRESETS.find(x => x.id === s.mode);
            const pName = p ? (p.name || p.id).toUpperCase() : 'AI';
            const div = document.createElement('div');
            div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
            div.innerHTML = `<span><span class="session-tag">${pName}</span> ${s.name}</span>`;
            div.onclick = () => { loadSession(s.id); if(window.innerWidth < 1000) toggleSidebar(); };
            list.appendChild(div);
        });
    }

    async function sendMessage() {
        if (isRequesting) return;
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text && currentImages.length === 0) return;
        
        const session = sessions.find(s => s.id === currentSessionId);
        if (!session) return;

        let msgPayload = text;
        if (currentImages.length > 0) {
            msgPayload = [{ type: "text", text: text || "Image" }];
            currentImages.forEach(img => {
                msgPayload.push({ type: "image_url", image_url: { url: img } });
            });
        }

        appendUI(null, "user", text, currentImages);
        session.messages.push({ role: "user", content: msgPayload });
        
        input.value = ''; input.style.height = 'auto'; currentImages = []; 
        document.getElementById('preview-area').innerHTML = '';

        isRequesting = true;
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true; sendBtn.style.opacity = '0.6';
        const loadingId = appendUI(null, "ai", "Thinking...", null, true);

        const box = document.getElementById('chat-box');
        box.scrollTop = box.scrollHeight;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ presetId: session.mode, messages: session.messages })
            });
            const data = await res.json();
            document.getElementById(loadingId).remove();
            
            if (!res.ok) throw new Error(data.error?.message || "è¯·æ±‚å¤±è´¥");
            
            const reply = data.choices[0].message.content;
            session.messages.push({ role: "assistant", content: reply });
            
            appendUI(null, "ai", reply);
            saveHistory();
        } catch (e) {
            if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            appendUI(null, "ai", `Error: ${e.message}`);
        } finally {
            // é‡ç‚¹ä¿®æ”¹ï¼šç§»é™¤ input.focus()ï¼Œé˜²æ­¢é”®ç›˜è‡ªåŠ¨å¼¹å‡º
            isRequesting = false; 
            sendBtn.disabled = false; 
            sendBtn.style.opacity = '1'; 
        }
    }

    function appendUI(id, role, text, imgs, isLoading) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.id = id || ('msg-' + Date.now());
        let content = `<div class="message-content">`;
        if (imgs && Array.isArray(imgs)) imgs.forEach(img => content += `<img src="${img}"><br>`);
        else if (imgs) content += `<img src="${imgs}"><br>`;

        if (isLoading) content += `<span style="color:#999">Thinking...</span>`;
        else content += `<pre>${text || ''}</pre>`;
        content += `</div>`;
        div.innerHTML = content;
        box.appendChild(div);
        return div.id;
    }

    function handleFileSelect(input) {
        if (input.files && input.files.length > 0) {
            if (currentImages.length + input.files.length > 4) { alert("ä¸€æ¬¡æœ€å¤šåªèƒ½å‘é€ 4 å¼ å›¾ç‰‡"); input.value = ''; return; }
            Array.from(input.files).forEach(file => {
                if (file.size > 5 * 1024 * 1024) { alert(`å›¾ç‰‡ ${file.name} å¤ªå¤§äº†ï¼Œè¯·ä¸Šä¼  5MB ä»¥å†…çš„å›¾ç‰‡`); return; }
                const reader = new FileReader();
                reader.onload = (e) => { currentImages.push(e.target.result); renderPreview(); };
                reader.readAsDataURL(file);
            });
        }
        input.value = '';
    }

    function renderPreview() {
        const area = document.getElementById('preview-area');
        area.innerHTML = '';
        currentImages.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `<img src="${img}"><button class="preview-remove" onclick="removeImage(${index})">âœ•</button>`;
            area.appendChild(div);
        });
    }

    function removeImage(index) { currentImages.splice(index, 1); renderPreview(); }

    // ç®¡ç†å‘˜åŠŸèƒ½
    function toggleCollapse(id) {
        const content = document.getElementById(id);
        const arrow = document.getElementById('arrow-' + id);
        content.classList.toggle('show');
        arrow.innerText = content.classList.contains('show') ? 'â–²' : 'â–¼';
    }

    async function openAdmin() {
        document.getElementById('adminModal').style.display = 'flex';
        try {
            const res = await fetch('/api/admin/data', { headers: { 'Authorization': `Bearer ${authToken}` } });
            const data = await res.json();
            if(data.success) {
                const tbody = document.querySelector('#statTable tbody');
                tbody.innerHTML = '';
                for (const [user, usage] of Object.entries(data.usage)) {
                    for (const [modelId, count] of Object.entries(usage)) {
                        const p = PRESETS.find(x => x.id === modelId);
                        const mName = p ? (p.name || modelId) : modelId;
                        tbody.innerHTML += `<tr><td>${user}</td><td>${mName}</td><td>${count}</td></tr>`;
                    }
                }
            }
        } catch(e){}
    }
    
    async function addPreset() {
        const name = document.getElementById('addName').value;
        const url = document.getElementById('addUrl').value;
        const key = document.getElementById('addKey').value;
        const modelId = document.getElementById('addModelId').value;
        const desc = document.getElementById('addDesc').value;
        if(!name || !url || !key || !modelId) return alert("è¯·å¡«å†™å®Œæ•´");
        
        await fetch('/api/admin/preset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ name, url, key, modelId, desc })
        });
        
        alert("æ·»åŠ æˆåŠŸ");
        document.getElementById('addName').value = '';
        document.getElementById('addDesc').value = '';
        document.getElementById('addUrl').value = '';
        document.getElementById('addKey').value = '';
        document.getElementById('addModelId').value = '';
        
        document.getElementById('adminModal').style.display = 'none';
        await fetchPresets(); // å¼ºåˆ¶åˆ·æ–°åˆ—è¡¨
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('show'); }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
    function toggleTheme() { const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('theme', n); }
</script>
</body>
</html>


