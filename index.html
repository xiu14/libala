<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ‘‚ğŸ»é»å§å•¦aiç«™ğŸ‘‚ğŸ»</title>
    <style>
        :root { --bg-color: #f8fafe; --chat-bg: #ffffff; --sidebar-bg: #ffffff; --text-color: #333333; --border-color: #ebedf0; --primary-color: #4f46e5; --my-msg-bg: #4f46e5; --my-msg-text: #ffffff; --ai-msg-bg: #f3f4f6; --ai-msg-text: #1f2937; --token-text: #9ca3af; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        [data-theme="dark"] { --bg-color: #111827; --chat-bg: #1f2937; --sidebar-bg: #1f2937; --text-color: #f3f4f6; --border-color: #374151; --primary-color: #6366f1; --my-msg-bg: #6366f1; --my-msg-text: #ffffff; --ai-msg-bg: #374151; --ai-msg-text: #f3f4f6; --token-text: #9ca3af; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; position: fixed; width: 100%; }
        
        /* ç™»å½•é¡µä¿®å¤ï¼šå¼ºåˆ¶æ–‡å­—é¢œè‰²ï¼Œé˜²æ­¢æ·±è‰²æ¨¡å¼ä¸‹é€æ˜ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; }
        .login-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 40px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); width: 90%; max-width: 350px; text-align: center; color: #333 !important; }
        .login-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #333 !important; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline:none; background: #fff; color: #333; }
        .login-btn { width: 100%; padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
        .login-btn:disabled { opacity: 0.7; cursor: not-allowed; }

        .app-container { display: none; height: 100%; position: relative; max-width: 1400px; margin: 0 auto; background: var(--chat-bg); box-shadow: var(--shadow); }
        @media (min-width: 1201px) { .app-container { height: 95vh; margin-top: 2.5vh; border-radius: 16px; overflow: hidden; } }
        
        /* ä¾§è¾¹æ ä¼˜åŒ–ï¼šæ»šåŠ¨æ¡ */
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 280px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transform: translateX(-100%); transition: var(--transition); z-index: 50; box-shadow: 10px 0 30px rgba(0,0,0,0.1); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .sidebar.open { transform: translateX(0); }
        .overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 40; }
        .overlay.show { display: block; }
        
        .mode-list { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .mode-card { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 10px; background: var(--bg-color); border: 1px solid transparent; cursor: pointer; transition: all 0.2s; }
        .mode-card:hover { border-color: var(--primary-color); background: rgba(79, 70, 229, 0.05); }
        .mode-icon { font-size: 20px; width: 30px; text-align: center;}
        .mode-info div:first-child { font-weight: 600; font-size: 13px; }
        .mode-info div:last-child { font-size: 11px; color: var(--token-text); }

        /* ä¼šè¯åˆ—è¡¨é¡¹æ ·å¼ä¼˜åŒ–ï¼šæ”¯æŒæŒ‰é’® */
        .session-list { display: flex; flex-direction: column; gap: 6px; margin-top: 5px; }
        .session-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: space-between; color: var(--text-color); transition: background 0.2s; group; position: relative; }
        .session-item:hover { background: rgba(0,0,0,0.03); }
        .session-item.active { background: rgba(79, 70, 229, 0.1); color: var(--primary-color); font-weight: 600; }
        
        .session-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 8px; }
        .session-actions { display: none; gap: 4px; }
        .session-item:hover .session-actions, .session-item.active .session-actions { display: flex; }
        .sess-btn { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; font-size: 12px; background: transparent; color: var(--token-text); }
        .sess-btn:hover { background: rgba(0,0,0,0.1); color: var(--text-color); }
        .sess-btn.del:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); }

        /* Admin Modal Scroll Fix */
        #adminModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; }
        .admin-panel { background: var(--bg-color); width: 95%; max-width: 600px; height: 85vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); background: var(--bg-color); }
        .admin-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .stat-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .stat-table th, .stat-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        
        .preset-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--chat-bg); border: 1px solid var(--border-color); margin-bottom: 8px; border-radius: 6px; }

        /* Chat Area */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; width: 100%; }
        .chat-header { padding: 0 20px; height: 60px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background-color: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); z-index: 10; flex-shrink: 0; }
        [data-theme="dark"] .chat-header { background-color: rgba(31, 41, 55, 0.85); }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        
        .message { max-width: 85%; display: flex; flex-direction: column; gap: 4px; }
        .user-msg { align-self: flex-end; align-items: flex-end; }
        .ai-msg { align-self: flex-start; align-items: flex-start; }
        .message-content { padding: 12px 16px; border-radius: 16px; font-size: 15px; line-height: 1.6; box-shadow: 0 1px 2px rgba(0,0,0,0.05); word-wrap: break-word; overflow-wrap: break-word; max-width: 100%; }
        .user-msg .message-content { background: var(--my-msg-bg); color: var(--my-msg-text); border-bottom-right-radius: 4px; }
        .ai-msg .message-content { background: var(--ai-msg-bg); color: var(--ai-msg-text); border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin-top: 8px; display: block; max-height: 400px; object-fit: contain; }
        .message pre { margin: 10px 0; white-space: pre-wrap; font-family: monospace; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; overflow-x: auto; }

        .input-wrapper { padding: 15px 20px; background: var(--chat-bg); width: 100%; padding-bottom: max(15px, env(safe-area-inset-bottom)); flex-shrink: 0; }
        .input-container { display: flex; align-items: flex-end; gap: 8px; background: var(--bg-color); padding: 8px 10px; border-radius: 16px; border: 1px solid var(--border-color); width: 100%; transition: border-color 0.2s; }
        .input-container:focus-within { border-color: var(--primary-color); }
        textarea { flex: 1; width: 0; min-width: 0; background: transparent; border: none; outline: none; resize: none; color: var(--text-color); font-size: 16px; max-height: 150px; font-family: inherit; padding: 8px 0; line-height: 1.5; }
        .action-btn { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; background: transparent; color: var(--token-text); font-size: 20px; display:flex; align-items:center; justify-content:center; flex-shrink: 0; margin-bottom: 2px; }
        .action-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary-color); }
        .send-btn { background: var(--primary-color); color: white; border-radius: 12px; width: 40px; height: 40px; font-size: 16px; transition: transform 0.1s; }
        .send-btn:active { transform: scale(0.95); }

        #preview-area { display: flex; gap: 8px; padding-bottom: 10px; flex-wrap: wrap; }
        .preview-item { 
            width: 64px; height: 64px; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg-color);
        }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-file { 
            position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; 
            border-radius: 50%; width: 18px; height: 18px; font-size: 12px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        @media (max-width: 768px) {
            .sidebar { width: 85%; max-width: 320px; }
            .chat-header { padding: 0 15px; height: 54px; }
            .input-wrapper { padding: 10px 12px; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>
<!-- ç™»å½•ç•Œé¢ -->
<div id="login-screen">
    <div class="login-box">
        <div class="login-title">ğŸ‘‚ğŸ»é»å§å•¦aiç«™ğŸ‘‚ğŸ»</div>
        <input type="text" id="loginUser" class="login-input" placeholder="è´¦å·">
        <input type="password" id="loginPass" class="login-input" placeholder="å¯†ç ">
        <button class="login-btn" onclick="handleLogin()">è¿›å…¥ AI ç©ºé—´</button>
    </div>
</div>

<!-- ç®¡ç†å‘˜å¼¹çª— -->
<div id="adminModal">
    <div class="admin-panel">
        <div class="admin-header">
            <h3 style="margin:0">âš™ï¸ ç®¡ç†åå°</h3>
            <button onclick="document.getElementById('adminModal').style.display='none'" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-color);">Ã—</button>
        </div>
        <div class="admin-body">
            <!-- ç»Ÿè®¡æ•°æ® -->
            <div>
                <h4 style="margin-bottom:10px; color:var(--primary-color);">ğŸ“Š è°ƒç”¨ç»Ÿè®¡</h4>
                <div style="border:1px solid var(--border-color); border-radius:8px; overflow:hidden;">
                    <table class="stat-table" id="statTable">
                        <thead style="background:var(--ai-msg-bg);"><tr><th>ç”¨æˆ·</th><th>æ¨¡å‹</th><th>æ¬¡æ•°</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- é¢„è®¾ç®¡ç† -->
            <div>
                <h4 style="margin-bottom:10px; color:var(--primary-color);">ğŸ¤– æ¨¡å‹é¢„è®¾ç®¡ç†</h4>
                <div id="adminPresetList"></div>
                
                <div style="margin-top:15px; background:var(--ai-msg-bg); padding:15px; border-radius:8px;">
                    <div style="font-weight:bold; margin-bottom:10px;">æ·»åŠ æ–°é¢„è®¾</div>
                    <input type="text" id="addName" class="login-input" style="padding:8px; margin-bottom:8px;" placeholder="æ˜¾ç¤ºåç§° (å¦‚: DeepSeek)">
                    <input type="text" id="addDesc" class="login-input" style="padding:8px; margin-bottom:8px;" placeholder="æè¿° (å¦‚: V3 Chat)">
                    <input type="text" id="addUrl" class="login-input" style="padding:8px; margin-bottom:8px;" placeholder="API Base URL">
                    <input type="text" id="addKey" class="login-input" style="padding:8px; margin-bottom:8px;" placeholder="API Key">
                    <input type="text" id="addModelId" class="login-input" style="padding:8px; margin-bottom:8px;" placeholder="Model ID">
                    <button class="login-btn" style="padding:8px;" onclick="addPreset()">æ·»åŠ é¢„è®¾</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="app-container" id="app">
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div style="font-size:12px; color:var(--token-text); margin-bottom:8px; font-weight:bold;">åˆ›å»ºæ–°ä¼šè¯</div>
            <div class="mode-list" id="presetList"></div>

            <div style="font-size:12px; color:var(--token-text); margin: 20px 0 8px 0; font-weight:bold; display:flex; justify-content:space-between;">
                <span>å†å²ä¼šè¯</span>
                <span id="sessionCount" style="font-weight:normal;">0/100</span>
            </div>
            <div class="session-list" id="sessionList"></div>
        </div>
        
        <div class="sidebar-footer">
            <button id="adminBtn" onclick="openAdmin()" style="display:none; width:100%; padding:10px; margin-bottom:10px; background:var(--chat-bg); border:1px solid var(--border-color); border-radius:8px; color:var(--text-color); cursor:pointer;">âš™ï¸ ç®¡ç†åå°</button>
            <button onclick="logout()" style="width:100%; padding:10px; background:#fee2e2; color:#ef4444; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»èŠå¤©åŒº -->
    <div class="main-chat">
        <header class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="menu-btn" onclick="toggleSidebar()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:5px; color:var(--text-color);">â‰¡</button>
                <div>
                    <div style="font-weight:700; font-size:16px; display:flex; align-items:center;">
                        <span style="width:8px; height:8px; background:#10b981; border-radius:50%; margin-right:8px;"></span>
                        <span id="headerTitle">AI Chat</span>
                    </div>
                </div>
            </div>
            <button class="action-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ—</button>
        </header>
        
        <div id="chat-box"></div>
        
        <div class="input-wrapper">
            <div id="preview-area"></div>
            <div class="input-container">
                <input type="file" id="fileInput" accept="image/*,.json,.txt,.js,.md,.csv,.py" multiple style="display:none;" onchange="handleFileSelect(this)">
                <button class="action-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>
                <textarea id="userInput" placeholder="è¾“å…¥æ¶ˆæ¯ (æ”¯æŒç²˜è´´æˆªå›¾)..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="action-btn send-btn" id="sendBtn" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>
</div>

<script>
    let PRESETS = []; 
    let currentSessionId = null;
    let isRequesting = false;
    let uploadedFiles = []; 
    let authToken = localStorage.getItem('authToken');
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    // åˆå§‹åŒ–
    window.onload = function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);

        if (authToken) initApp();

        // ç»‘å®šå›è½¦å‘é€
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey && !isTouchDevice()) { 
                e.preventDefault(); sendMessage(); 
            }
        });

        // ç»‘å®šç²˜è´´äº‹ä»¶ (Ctrl+V)
        window.addEventListener('paste', handlePaste);
    };

    function isTouchDevice() { return 'ontouchstart' in window || navigator.maxTouchPoints > 0; }

    async function handleLogin() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        const btn = document.querySelector('.login-btn');
        btn.disabled = true; btn.innerText = "éªŒè¯ä¸­...";
        try {
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p }) });
            const data = await res.json();
            if (data.success) {
                authToken = data.token;
                isAdmin = data.isAdmin;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('isAdmin', isAdmin);
                initApp();
            } else { alert(data.message); }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
        finally { btn.disabled = false; btn.innerText = "è¿›å…¥ AI ç©ºé—´"; }
    }

    function logout() { 
        localStorage.removeItem('authToken'); 
        localStorage.removeItem('isAdmin');
        location.reload(); 
    }

    async function initApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        if(isAdmin) document.getElementById('adminBtn').style.display = 'block';
        await fetchPresets(); 
        await fetchSessions(); 
    }

    // --- ä¼šè¯ç®¡ç† ---
    async function fetchSessions() {
        try {
            const res = await fetch('/api/sessions', { headers: { 'Authorization': `Bearer ${authToken}` } });
            const json = await res.json();
            if (json.success) {
                const list = document.getElementById('sessionList');
                list.innerHTML = '';
                document.getElementById('sessionCount').innerText = `${json.data.length}/100`;

                json.data.forEach(s => {
                    const preset = PRESETS.find(p => p.id === s.mode);
                    const icon = preset ? preset.icon : 'ğŸ’¬';
                    const activeClass = s.id === currentSessionId ? 'active' : '';
                    
                    const div = document.createElement('div');
                    div.className = `session-item ${activeClass}`;
                    div.innerHTML = `
                        <div class="session-title" onclick="loadSession('${s.id}')">
                            <span style="margin-right:5px;">${icon}</span> ${s.title}
                        </div>
                        <div class="session-actions">
                            <button class="sess-btn" onclick="renameSession('${s.id}', '${s.title}')" title="é‡å‘½å">âœ</button>
                            <button class="sess-btn del" onclick="deleteSession('${s.id}')" title="åˆ é™¤">ğŸ—‘</button>
                        </div>
                    `;
                    list.appendChild(div);
                });

                // å¦‚æœæ²¡æœ‰å½“å‰ä¼šè¯ä½†æœ‰åˆ—è¡¨ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ªï¼›å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼ŒåŠ è½½å¼•å¯¼é¡µ
                if (!currentSessionId && json.data.length > 0) {
                    loadSession(json.data[0].id);
                } else if (json.data.length === 0) {
                    document.getElementById('chat-box').innerHTML = '<div style="text-align:center; padding:50px; color:var(--token-text);">ğŸ‘‹ è¯·ä»å·¦ä¾§é€‰æ‹©æ¨¡å‹å¼€å§‹æ–°å¯¹è¯</div>';
                }
            }
        } catch(e) { console.error(e); }
    }

    async function loadSession(id) {
        if(isRequesting) return;
        currentSessionId = id;
        
        // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.session-item').forEach(el => el.classList.remove('active'));
        // è¿™é‡Œåªæ˜¯ç®€å•çš„å…¨éƒ¨åˆ·æ–°ï¼Œå®é™…å¯ä»¥ç”¨IDæŸ¥æ‰¾DOMæ›´æ–°class
        // ä¸ºäº†ä»£ç ç®€å•ï¼Œæˆ‘ä»¬é‡æ–°æ¸²æŸ“åˆ—è¡¨(å› ä¸ºupdated_atä¹Ÿå˜äº†é¡ºåºå¯èƒ½è¦å˜)
        // ä½†ä¸ºäº†é˜²æ­¢é—ªçƒï¼Œè¿™é‡Œæš‚ä¸é‡æ–°fetchï¼Œåªæ‰‹åŠ¨è®¾ç½®activeæ ·å¼
        // (çœç•¥æ‰‹åŠ¨è®¾ç½®classé€»è¾‘ï¼Œç›´æ¥åœ¨renderæ—¶å¤„ç†)
        
        const box = document.getElementById('chat-box');
        box.innerHTML = '<div style="text-align:center; padding:20px;">åŠ è½½ä¸­...</div>';

        try {
            const res = await fetch(`/api/session/${id}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const json = await res.json();
            if (json.success) {
                document.getElementById('headerTitle').innerText = json.session.title;
                box.innerHTML = '';
                
                if (json.messages.length === 0) {
                     box.innerHTML = '<div style="text-align:center; padding:50px; color:var(--token-text);">å¼€å§‹æ–°çš„å¯¹è¯...</div>';
                } else {
                    json.messages.forEach(msg => {
                        let text = "";
                        let imgs = [];
                        if (typeof msg.content === 'string') text = msg.content;
                        else {
                            msg.content.forEach(c => {
                                if (c.type === 'text') text += c.text;
                                if (c.type === 'image_url') imgs.push(c.image_url.url);
                            });
                        }
                        appendUI(null, msg.role, text, imgs);
                    });
                }
                
                // å…³é—­æ‰‹æœºç«¯ä¾§è¾¹æ 
                if(window.innerWidth < 1000) {
                    document.getElementById('sidebar').classList.remove('open');
                    document.querySelector('.overlay').classList.remove('show');
                }
            }
        } catch(e) {
            box.innerHTML = `<div style="color:red; text-align:center;">åŠ è½½å¤±è´¥: ${e.message}</div>`;
        }
        
        // åˆ·æ–°åˆ—è¡¨é«˜äº®
        await fetchSessions();
    }

    async function createNewSession(presetId) {
        try {
            const res = await fetch('/api/session/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ presetId: presetId })
            });
            const json = await res.json();
            if (json.success) {
                await fetchSessions();
                loadSession(json.id);
            } else { alert("åˆ›å»ºå¤±è´¥: " + json.message); }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    async function renameSession(id, oldTitle) {
        const newTitle = prompt("è¯·è¾“å…¥æ–°æ ‡é¢˜", oldTitle);
        if (newTitle && newTitle !== oldTitle) {
            await fetch('/api/session/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ id, title: newTitle })
            });
            fetchSessions();
            if (currentSessionId === id) document.getElementById('headerTitle').innerText = newTitle;
        }
    }

    async function deleteSession(id) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçª—å£å—ï¼ŸèŠå¤©è®°å½•å°†æ— æ³•æ¢å¤ã€‚")) return;
        await fetch('/api/session/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ id })
        });
        if (currentSessionId === id) {
            currentSessionId = null;
            document.getElementById('chat-box').innerHTML = '';
            document.getElementById('headerTitle').innerText = 'AI Chat';
        }
        fetchSessions();
    }

    // --- èŠå¤©å‘é€é€»è¾‘ ---
    async function sendMessage() {
        if (isRequesting || !currentSessionId) return;
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text && uploadedFiles.length === 0) return;

        // æ„é€ æ¶ˆæ¯ä½“
        let contentPayload = [];
        if (uploadedFiles.length > 0) {
            uploadedFiles.forEach(f => {
                if (f.type.startsWith('image/')) {
                    contentPayload.push({ type: "image_url", image_url: { url: f.data } });
                } else {
                    // æ–‡æœ¬æ–‡ä»¶ä½œä¸ºæ–‡æœ¬å†…å®¹é™„åŠ 
                    contentPayload.push({ type: "text", text: `[æ–‡ä»¶ ${f.name}]:\n${f.data}\n` });
                }
            });
        }
        if (text) contentPayload.push({ type: "text", text: text });
        
        // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡æœ¬ï¼Œç®€åŒ–ç»“æ„ï¼ˆå¯é€‰ï¼Œä½†ä¸ºäº†ç»Ÿä¸€å»ºè®®ä¿æŒæ•°ç»„æˆ–åç«¯å¤„ç†ï¼‰
        // è¿™é‡Œä¸ºäº†å…¼å®¹æ€§ï¼Œæ··åˆå†…å®¹ç»Ÿä¸€ç”¨æ•°ç»„
        
        // UI ä¹è§‚æ›´æ–°
        let displayImgs = uploadedFiles.filter(f => f.type.startsWith('image/')).map(f => f.data);
        let displayText = text + (uploadedFiles.length > 0 ? `\n(ğŸ“ ${uploadedFiles.length} é™„ä»¶)` : "");
        appendUI(null, "user", displayText, displayImgs);

        // æ¸…ç†è¾“å…¥æ¡†
        input.value = ''; input.style.height = 'auto';
        uploadedFiles = []; renderPreviews();

        isRequesting = true;
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true; sendBtn.style.opacity = '0.5';
        const loadingId = appendUI(null, "ai", "Thinking...", [], true);

        // è·å–å½“å‰ä¼šè¯çš„å†å²è®°å½• (ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åœ¨åç«¯å…¶å®åªå­˜äº†å†å²ï¼Œä½†è°ƒç”¨APIæ—¶éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡)
        // ä¸ºäº†æ€§èƒ½ï¼Œå‰ç«¯ä¸å†ç»´æŠ¤å·¨å¤§çš„ messages æ•°ç»„ï¼Œè€Œæ˜¯å‡è®¾åç«¯ä¼šå¤„ç†ä¸Šä¸‹æ–‡ã€‚
        // ä½†æ ‡å‡†çš„ OpenAI API æ˜¯æ— çŠ¶æ€çš„ã€‚
        // **ç­–ç•¥ä¿®æ­£**: å‰ç«¯éœ€è¦æŠŠæ–°æ¶ˆæ¯å‘ç»™åç«¯ï¼Œåç«¯ï¼š
        // 1. è¯»å–è¯¥ Session çš„å†å²æ¶ˆæ¯
        // 2. æ‹¼æ¥æ–°æ¶ˆæ¯
        // 3. è¯·æ±‚ AI
        // 4. ä¿å­˜æ–°æ¶ˆæ¯å’Œ AI å›å¤
        
        // è¿™é‡Œçš„ fetch åªéœ€å‘æ–°æ¶ˆæ¯ï¼Œå…·ä½“çš„ä¸Šä¸‹æ–‡æ‹¼æ¥ç”±åç«¯ session/chat æ¥å£å®Œæˆ
        try {
            // è·å–å½“å‰ä¼šè¯è¯¦æƒ…ä»¥å¾—åˆ° modelId
            // å®é™…ä¸Šæˆ‘ä»¬åº”è¯¥æŠŠ mode å­˜åœ¨æœ¬åœ°æˆ–ä¸éœ€è¦ä¼ ï¼Œåç«¯æ ¹æ® sessionId æŸ¥åº“
            // è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä¼  sessionId å’Œ new message
            
            // æ³¨æ„ï¼šå› ä¸ºåç«¯ä»£ç é‡Œ /api/chat æ˜¯æ— çŠ¶æ€è½¬å‘è¿˜æ˜¯å¸¦çŠ¶æ€ï¼Ÿ
            // çœ‹ server.js: /api/chat æ¥æ”¶ { sessionId, presetId, messages }
            // æ­¤æ—¶ messages åº”è¯¥æ˜¯åŒ…å«å†å²çš„å®Œæ•´æ•°ç»„ã€‚
            // ä¸ºäº†é¿å…å‰ç«¯å­˜å‚¨å¤§é‡æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å…ˆ fetch å†å²? 
            // **ä¼˜åŒ–æ–¹æ¡ˆ**: ä¿®æ”¹å‰ç«¯é€»è¾‘ï¼Œä» UI æå–ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…æ›´ç¨³å¦¥åœ°ï¼š
            // è®© server.js çš„ /api/chat èƒ½å¤Ÿåªæ¥æ”¶æ–°æ¶ˆæ¯ï¼Œç„¶åè‡ªå·±åœ¨æœåŠ¡ç«¯ç»„è£…å†å²ã€‚
            // ä½†æ—¢ç„¶ server.js æ˜¯é€šç”¨çš„è½¬å‘ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦æ„å»ºå®Œæ•´çš„ messages æ•°ç»„ã€‚
            
            // 1. ä¸´æ—¶æ‹‰å–æœ€æ–°å†å² (æˆ–è€…æˆ‘ä»¬åœ¨ loadSession æ—¶ç¼“å­˜äº† messages)
            // ä¸ºäº†ä¸¥è°¨ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ª messages æ•°ç»„
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬é‡æ–° fetch ä¸€æ¬¡ session è¯¦æƒ…æ‹¿åˆ°å†å²ï¼ŒåŠ ä¸Šå½“å‰æ¶ˆæ¯
            // è¿™ç§æ–¹å¼è™½ç„¶å¤šä¸€æ¬¡è¯·æ±‚ï¼Œä½†ä¿è¯äº†å¤šç«¯åŒæ­¥å’Œæ•°æ®ä¸€è‡´æ€§ã€‚
            
            const sessionRes = await fetch(`/api/session/${currentSessionId}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const sessionData = await sessionRes.json();
            
            let fullMessages = sessionData.messages || []; // è¿™æ˜¯å†å²
            // è¿½åŠ å½“å‰æ–°æ¶ˆæ¯
            const newUserMsg = { role: "user", content: contentPayload };
            fullMessages.push(newUserMsg);

            // å‘é€è¯·æ±‚
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ 
                    sessionId: currentSessionId, 
                    presetId: sessionData.session.mode, 
                    messages: fullMessages 
                })
            });
            
            const data = await res.json();
            document.getElementById(loadingId).remove();
            
            if (!res.ok) throw new Error(data.error?.message || "è¯·æ±‚å¤±è´¥");
            
            const reply = data.choices[0].message.content;
            appendUI(null, "ai", reply);
            
            // åˆ·æ–°åˆ—è¡¨é¡ºåº (å› ä¸º updated_at å˜äº†)
            fetchSessions();

        } catch (e) {
            document.getElementById(loadingId).remove();
            appendUI(null, "ai", `Error: ${e.message}`);
        } finally {
            isRequesting = false;
            sendBtn.disabled = false; sendBtn.style.opacity = '1';
            input.focus();
        }
    }

    // --- å·¥å…·å‡½æ•° ---
    function appendUI(id, role, text, images = [], isLoading = false) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.id = id || ('msg-' + Date.now());
        
        let content = `<div class="message-content">`;
        if (images && images.length > 0) {
            images.forEach(url => { content += `<img src="${url}"><br>`; });
        }
        if (isLoading) content += `<span style="color:#999; animation: blink 1s infinite;">Thinking...</span>`;
        else if (text) content += `<pre>${text}</pre>`;
        content += `</div>`;
        
        div.innerHTML = content;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return div.id;
    }

    function handlePaste(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        let hasFile = false;
        for (let item of items) {
            if (item.kind === 'file') {
                const file = item.getAsFile();
                processFile(file);
                hasFile = true;
            }
        }
        if(hasFile) e.preventDefault();
    }

    function handleFileSelect(input) {
        if (!input.files.length) return;
        Array.from(input.files).forEach(file => processFile(file));
        input.value = '';
    }

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedFiles.push({ name: file.name, type: file.type, data: e.target.result });
            renderPreviews();
        };
        if (file.type.startsWith('image/')) reader.readAsDataURL(file);
        else reader.readAsText(file);
    }

    function renderPreviews() {
        const area = document.getElementById('preview-area');
        area.innerHTML = '';
        uploadedFiles.forEach((f, i) => {
            let inner = f.type.startsWith('image/') ? `<img src="${f.data}">` : `<div style="font-size:20px;">ğŸ“„</div>`;
            area.innerHTML += `<div class="preview-item">${inner}<div class="remove-file" onclick="uploadedFiles.splice(${i},1);renderPreviews()">Ã—</div></div>`;
        });
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 150) + 'px';
    }

    // --- ç®¡ç†å‘˜ & é¢„è®¾ ---
    async function fetchPresets() {
        try {
            const res = await fetch('/api/config');
            const data = await res.json();
            if (data.success) {
                PRESETS = data.presets;
                renderPresetsSidebar();
            }
        } catch(e) {}
    }

    function renderPresetsSidebar() {
        const list = document.getElementById('presetList');
        list.innerHTML = '';
        PRESETS.forEach(p => {
            const div = document.createElement('div');
            div.className = 'mode-card';
            div.onclick = () => createNewSession(p.id);
            div.innerHTML = `<div class="mode-icon">${p.icon||'âš¡'}</div><div class="mode-info"><div>${p.name}</div><div>${p.desc}</div></div>`;
            list.appendChild(div);
        });
    }

    async function openAdmin() {
        document.getElementById('adminModal').style.display = 'flex';
        // åŠ è½½æ•°æ®
        const res = await fetch('/api/admin/data', { headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        
        // æ¸²æŸ“ç»Ÿè®¡
        const tbody = document.querySelector('#statTable tbody');
        tbody.innerHTML = '';
        if (data.usage) {
            for (const [user, usage] of Object.entries(data.usage)) {
                for (const [mid, count] of Object.entries(usage)) {
                    tbody.innerHTML += `<tr><td>${user}</td><td>${mid}</td><td>${count}</td></tr>`;
                }
            }
        }

        // æ¸²æŸ“é¢„è®¾ç®¡ç†åˆ—è¡¨
        const pList = document.getElementById('adminPresetList');
        pList.innerHTML = '';
        data.presets.forEach(p => {
            pList.innerHTML += `
                <div class="preset-row">
                    <div>
                        <strong>${p.name}</strong> <small>(${p.modelId})</small>
                        <div style="font-size:12px; color:#666;">${p.url}</div>
                    </div>
                    <button onclick="deletePreset('${p.id}')" style="background:#fee2e2; color:red; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">åˆ é™¤</button>
                </div>
            `;
        });
    }

    async function addPreset() {
        const name = document.getElementById('addName').value;
        const url = document.getElementById('addUrl').value;
        const key = document.getElementById('addKey').value;
        const modelId = document.getElementById('addModelId').value;
        const desc = document.getElementById('addDesc').value;
        
        if(!name || !url || !key || !modelId) return alert("è¯·å¡«å†™å®Œæ•´");
        
        await fetch('/api/admin/preset', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, 
            body: JSON.stringify({ name, url, key, modelId, desc }) 
        });
        alert("æ·»åŠ æˆåŠŸ");
        openAdmin(); // åˆ·æ–°åˆ—è¡¨
        fetchPresets(); // åˆ·æ–°ä¾§è¾¹æ 
    }

    async function deletePreset(id) {
        if(!confirm("ç¡®å®šåˆ é™¤æ­¤é¢„è®¾å—ï¼Ÿ")) return;
        await fetch('/api/admin/preset/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, 
            body: JSON.stringify({ id }) 
        });
        openAdmin();
        fetchPresets();
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('show'); }
    function toggleTheme() {
        const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', n);
        localStorage.setItem('theme', n);
    }
</script>
</body>
</html>

