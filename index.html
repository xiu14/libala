<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å·¦è€³ AI | Li Bala's Ear</title>
    
    <!-- é¢„åŠ è½½ Logo -->
    <link rel="preload" as="image" href="logo.png">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
    
    <!-- ç™»å½•é¡µä¸“ç”¨æ ·å¼ -->
    <style>
        #login-screen {
            background: radial-gradient(circle at 30% 20%, #2a2340, #0c0c16) !important;
            font-family: "Segoe UI", sans-serif;
            color: #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        .login-logo {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 25px rgba(156, 116, 255, 0.4);
            border: 2px solid rgba(156, 116, 255, 0.2);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .login-title-text {
            font-size: 24px;
            margin-bottom: 8px;
            text-align: center;
            padding: 0 20px;
        }

        .login-subtitle {
            opacity: 0.7;
            margin-bottom: 30px;
            font-size: 14px;
            text-align: center;
            padding: 0 20px;
            line-height: 1.5;
        }

        #login-screen .login-box {
            padding: 30px;
            width: 85%;
            max-width: 340px;
            background: rgba(255,255,255,0.05) !important;
            backdrop-filter: blur(10px);
            border-radius: 12px;
            position: relative;
            border: none !important;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3) !important;
        }

        #login-screen .login-box::before {
            content: "";
            position: absolute;
            left: 0;
            top: 10%;
            height: 80%;
            width: 3px;
            background: linear-gradient(#9c74ff, #c0a5ff);
            box-shadow: 0 0 15px #b48dff;
            border-radius: 2px;
        }

        #login-screen .login-input {
            width: 100%;
            padding: 14px;
            margin: 0 0 16px 0;
            border: none !important;
            border-radius: 8px;
            background: rgba(255,255,255,0.12) !important;
            color: #fff !important;
            outline: none;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        #login-screen .login-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        #login-screen .login-btn {
            width: 100%;
            padding: 14px;
            border: none;
            background: #9c74ff !important;
            color: white !important;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        #login-screen .login-btn:hover {
            background: #b48dff !important;
            box-shadow: 0 0 20px #b48dff;
            transform: translateY(-1px);
        }
        
        #login-screen .login-btn:active {
            transform: scale(0.98);
        }

        .switch-mode-text {
            margin-top: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .switch-mode-text:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(156, 116, 255, 0.6);
        }

        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å…¬å‘Š Tab æ ·å¼ */
        .announce-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-color);
        }
        .announce-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.2s;
        }
        .announce-tab.active {
            color: var(--text-color);
            border-bottom: 2px solid var(--primary-color);
            background: var(--chat-bg);
        }
        
        @media (max-height: 600px) { .login-logo { width: 100px; height: 100px; margin-bottom: 10px; } .login-subtitle { margin-bottom: 15px; } }
    </style>
</head>
<body>

<div id="login-screen">
    <!-- è¯·ç¡®ä¿æ ¹ç›®å½•ä¸‹æœ‰ logo.png -->
    <img src="logo.png" alt="å·¦è€³AI" class="login-logo">

    <div class="login-title-text">Welcome to å·¦è€³ AI</div>
    <div class="login-subtitle">é»å§å•¦åœ¨å¬ã€‚</div>

    <div class="login-box">
        <!-- ç™»å½•æ¡† -->
        <input type="text" id="loginUser" class="login-input" placeholder="å†™ä¸Šä½ çš„ä»£å·ï¼Œé»å§å•¦åœ¨å¬ã€‚" autocomplete="off">
        <input type="password" id="loginPass" class="login-input" placeholder="å˜˜ï¼Œè¯´å°å£°ç‚¹ã€‚">
        
        <!-- æ³¨å†Œéšè—æ¡† -->
        <input type="password" id="loginPassConfirm" class="login-input" placeholder="å†è¯´ä¸€éæš—å·ã€‚" style="display:none;">
        <input type="text" id="regInviteCode" class="login-input" placeholder="é‚€è¯·ç  (å¿…å¡«)" style="display:none;">
        
        <button class="login-btn" id="actionBtn" onclick="handleSubmit()">è¿›å…¥ç«™ç‚¹</button>
        
        <div class="switch-mode-text" onclick="toggleRegisterMode()">
            æ²¡æœ‰é€šè¡Œè¯ï¼Ÿ<span style="color: #9c74ff; font-weight:600;">ç«‹å³æ³¨å†Œ</span>
        </div>
    </div>
</div>

<!-- å…¬å‘Šå¼¹çª— -->
<div id="announceModal" class="modal">
    <div class="modal-panel" style="max-width: 600px; height: 70vh;">
        <div class="modal-header" style="flex-shrink:0;">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;">ğŸ“¢ ç«™ç‚¹å…¬å‘Š</h3>
            <button class="icon-btn" onclick="document.getElementById('announceModal').classList.remove('open')"><i data-lucide="x"></i></button>
        </div>
        
        <!-- Tab åˆ‡æ¢ -->
        <div class="announce-tabs">
            <div class="announce-tab active" onclick="switchAnnounceTab('latest')" id="tab-latest">æœ€æ–°å…¬å‘Š</div>
            <div class="announce-tab" onclick="switchAnnounceTab('history')" id="tab-history">å†å²è®°å½•</div>
        </div>

        <!-- å†…å®¹æ˜¾ç¤ºåŒº -->
        <div id="announceContentArea" style="flex:1; overflow-y:auto; padding:0;">
            <div id="view-latest" class="announce-content" style="padding:20px;"></div>
            <div id="view-history" style="display:none; padding:10px;">
                <div id="announceHistoryList" style="display:flex; flex-direction:column; gap:12px;"></div>
            </div>
        </div>

        <div style="padding:16px; border-top:1px solid var(--border-color); text-align:right; flex-shrink:0;">
             <button class="login-btn" style="width:auto; padding:8px 24px;" onclick="closeAnnouncement()">çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<!-- ç®¡ç†åå° -->
<div id="adminModal" class="modal">
    <div class="modal-panel">
        <div class="modal-header">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i data-lucide="settings-2"></i> ç®¡ç†åå°</h3>
            <button class="icon-btn" onclick="document.getElementById('adminModal').classList.remove('open')"><i data-lucide="x"></i></button>
        </div>
        <div class="admin-body" style="flex:1; overflow-y:auto; padding:24px;">
            
            <!-- 1. å…¬å‘Šç®¡ç† -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this); fetchAdminAnnouncements();">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="megaphone"></i> å…¬å‘Šç®¡ç†</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <textarea id="announceInput" class="login-input" style="height:80px; resize:vertical; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="å‘å¸ƒæ–°å…¬å‘Š (è‡ªåŠ¨è¿½åŠ å½“å‰æ—¶é—´)"></textarea>
                    <div style="text-align:right; margin-bottom:16px;">
                        <button class="login-btn" style="width:auto; padding:8px 20px;" onclick="postAnnouncement()">å‘å¸ƒ</button>
                    </div>
                    <div style="border-top:1px solid var(--border-color); padding-top:12px;">
                        <div style="font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:8px;">å†å²å…¬å‘Š (ç®¡ç†)</div>
                        <div id="adminAnnounceList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    </div>
                </div>
            </div>

            <!-- 2. é‚€è¯·ç ç®¡ç† -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this); fetchInviteInfo();">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="ticket"></i> é‚€è¯·ç ç®¡ç†</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; background:var(--bg-color); padding:12px; border-radius:8px; border:1px solid var(--border-color);">
                        <span style="font-size:14px; font-weight:500;">å¯ç”¨æ³¨å†Œé‚€è¯·åˆ¶</span>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span id="inviteStatusText" style="font-size:12px; color:var(--text-secondary);">å·²å…³é—­</span>
                            <button id="inviteToggleBtn" onclick="toggleInviteSystem()" class="login-btn" style="width:auto; padding:6px 16px; font-size:12px; background:var(--text-secondary)!important;">å¼€å¯</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:16px; display:flex; gap:12px;">
                        <button class="login-btn" style="flex:1;" onclick="generateInviteCode()">ğŸ² ç”Ÿæˆéšæœºé‚€è¯·ç </button>
                    </div>

                    <div style="font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:8px;">æœ‰æ•ˆé‚€è¯·ç åˆ—è¡¨ (ç‚¹å‡»å¯å¤åˆ¶)</div>
                    <div id="inviteCodeList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:8px;"></div>
                </div>
            </div>

            <!-- 3. æ•°æ®ç»Ÿè®¡ -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="bar-chart-3"></i> è°ƒç”¨ç»Ÿè®¡</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div id="statGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;"></div>
                </div>
            </div>
            
            <!-- 4. æ¨¡å‹é¢„è®¾ç®¡ç† -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="cpu"></i> æ¨¡å‹é¢„è®¾ç®¡ç†</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div id="adminPresetList" style="margin-bottom:16px; display:flex; flex-direction:column; gap:8px;"></div>
                    <div style="background:var(--bg-color); padding:16px; border-radius:8px; border:1px solid var(--border-color); margin-top:16px;">
                        <div style="font-weight:600; margin-bottom:12px; font-size:14px;" id="addFormTitle">æ·»åŠ æ–°é¢„è®¾</div>
                        
                        <!-- ID è¾“å…¥æ¡† (ä¸å†æ˜¯ hidden) -->
                        <input type="text" id="addId" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="ID (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆï¼Œç½®é¡¶å¡« libala_main)">
                        
                        <div style="display:grid; gap:12px; margin-top:12px;">
                            <input type="text" id="addName" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="æ˜¾ç¤ºåç§°">
                            
                            <!-- æ–°å¢ï¼šå›¾æ ‡ URL è¾“å…¥æ¡† -->
                            <input type="text" id="addIcon" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="å›¾æ ‡ (è¾“å…¥Emoji æˆ– å›¾ç‰‡URL)">
                            
                            <input type="text" id="addDesc" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="æè¿°">
                            
                            <!-- System Prompt è¾“å…¥æ¡† -->
                            <textarea id="addPrompt" class="login-input" style="margin:0; height:80px; resize:vertical; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="System Prompt (ä¾‹å¦‚ï¼šä½ ç°åœ¨æ‰®æ¼”é»å§å•¦...)"></textarea>

                            <input type="text" id="addUrl" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="API Base URL">
                            <input type="text" id="addKey" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="API Key">
                            <input type="text" id="addModelId" class="login-input" style="margin:0; background:var(--bg-color)!important; color:var(--text-color)!important; border:1px solid var(--border-color)!important;" placeholder="Model ID">
                            <div style="display:flex; gap:12px;">
                                <button class="login-btn" style="flex:1;" onclick="savePreset()" id="savePresetBtn">ä¿å­˜é…ç½®</button>
                                <button class="btn-ghost" style="width:auto; padding:0 20px; border-radius:12px;" onclick="resetPresetForm()">é‡ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align:center; margin-top:20px;">
                <button class="btn-danger sidebar-btn" onclick="forceMigrate()" style="justify-content:center;">
                    <i data-lucide="database-backup"></i> ä»æ—§æ•°æ®å¯¼å…¥
                </button>
            </div>
        </div>
    </div>
</div>

<div class="app-container" id="app">
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢..." oninput="handleSearch(this.value)">
                <i data-lucide="search" class="search-icon"></i>
            </div>
            <div id="normalSidebarList" style="display:flex; flex-direction:column; gap:24px;">
                <div><div class="section-title">æ–°å¯¹è¯</div><div class="mode-list" id="presetList"></div></div>
                <div>
                    <div class="section-title" style="display:flex; justify-content:space-between;"><span>å†å²è®°å½•</span><span id="sessionCount" style="font-weight:normal;"></span></div>
                    <div id="sessionListContainer"></div>
                </div>
            </div>
            <div id="searchResultList" style="display:none;">
                <div class="section-title">æœç´¢ç»“æœ</div>
                <div id="searchOutput" style="display:flex; flex-direction:column; gap:4px;"></div>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="sidebar-btn btn-ghost" onclick="checkAnnouncement(true)"><i data-lucide="bell"></i> æŸ¥çœ‹å…¬å‘Š</button>
            <button id="adminBtn" onclick="openAdmin()" class="sidebar-btn btn-ghost" style="display:none;"><i data-lucide="settings"></i> è®¾ç½®</button>
            <button onclick="logout()" class="sidebar-btn btn-danger"><i data-lucide="log-out"></i> é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="main-chat">
        <header class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="icon-btn" onclick="toggleSidebar()" style="color:var(--text-color);"><i data-lucide="menu"></i></button>
                <div style="font-weight:600; font-size:16px; display:flex; align-items:center; color:var(--text-color);">
                    <span style="width:8px; height:8px; background:#10b981; border-radius:50%; margin-right:8px; display:inline-block;"></span>
                    <span id="headerTitle">å·¦è€³ AI</span>
                </div>
            </div>
            <div style="display:flex; gap:4px;">
                <button class="icon-btn" onclick="toggleTheme()"><i data-lucide="moon" id="themeIcon"></i></button>
            </div>
        </header>
        
        <div id="chat-box"></div>
        
        <div class="input-wrapper">
            <div id="preview-area"></div>
            <div class="input-box">
                <input type="file" id="fileInput" accept="image/*,.json,.txt,.js,.md,.csv,.py" multiple style="display:none;" onchange="handleFileSelect(this)">
                
                <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="ä¸Šä¼ æ–‡ä»¶" style="align-self:flex-end; margin-bottom:2px;">
                    <i data-lucide="paperclip"></i>
                </button>
                <button class="icon-btn" id="searchToggleBtn" onclick="toggleSearch()" title="å¼€å¯è”ç½‘æœç´¢" style="align-self:flex-end; margin-bottom:2px;">
                    <i data-lucide="globe"></i>
                </button>

                <textarea id="userInput" placeholder="é»å§å•¦æ­£åœ¨è†å¬..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i data-lucide="arrow-up"></i>
                </button>
            </div>
        </div>
    </div>
</div>
<script src="app.js"></script>
</body>
</html>


