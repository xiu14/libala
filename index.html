<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Workspace</title>
    <!-- ÂºïÂÖ• Markdown Ëß£ÊûêÂô® -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- ÂºïÂÖ• ‰ª£Á†ÅÈ´ò‰∫Æ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- ÂºïÂÖ• DOMPurify Èò≤Ê≠¢ XSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <!-- ÂºïÂÖ• Lucide ÂõæÊ†áÂ∫ì -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Slate Color Palette */
        :root { 
            --bg-color: #f8fafc; 
            --chat-bg: #ffffff; 
            --sidebar-bg: #f1f5f9; 
            --text-color: #334155; 
            --text-secondary: #64748b;
            --border-color: #e2e8f0; 
            
            --primary-color: #475569; 
            --primary-hover: #1e293b; 
            
            --my-msg-bg: #475569; 
            --my-msg-text: #ffffff; 
            
            --ai-msg-bg: #f1f5f9; 
            --ai-msg-text: #1e293b; 
            
            --danger-color: #ef4444;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        [data-theme="dark"] { 
            --bg-color: #020617; 
            --chat-bg: #0f172a; 
            --sidebar-bg: #020617; 
            --text-color: #e2e8f0; 
            --text-secondary: #94a3b8; 
            --border-color: #1e293b; 
            
            --primary-color: #cbd5e1; 
            --primary-hover: #ffffff;
            
            --my-msg-bg: #334155; 
            --my-msg-text: #f8fafc; 
            
            --ai-msg-bg: #1e293b; 
            --ai-msg-text: #f1f5f9; 
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; position: fixed; width: 100%; }
        
        /* ÈÄöÁî®ÊåâÈíÆÊ†∑Âºè */
        .icon-btn { 
            background: transparent; border: none; cursor: pointer; color: var(--text-secondary); 
            padding: 8px; border-radius: 6px; transition: var(--transition); display: flex; align-items: center; justify-content: center; 
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); color: var(--text-color); }
        [data-theme="dark"] .icon-btn:hover { background: rgba(255,255,255,0.1); }

        /* ÁôªÂΩïÈ°µ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; }
        .login-box { background: var(--chat-bg); padding: 40px; border-radius: 24px; border: 1px solid var(--border-color); width: 90%; max-width: 360px; text-align: center; box-shadow: var(--shadow); }
        .login-title { font-size: 24px; font-weight: 600; margin-bottom: 24px; color: var(--text-color); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-input { width: 100%; padding: 12px 16px; margin-bottom: 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 15px; background: var(--bg-color); color: var(--text-color); transition: border-color 0.2s; }
        .login-input:focus { border-color: var(--text-secondary); }
        .login-btn { width: 100%; padding: 12px; background: var(--text-color); color: var(--chat-bg); border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px; margin-top: 8px; }
        
        /* ‰∏ªÂ∏ÉÂ±Ä */
        .app-container { display: none; height: 100%; position: relative; max-width: 1600px; margin: 0 auto; background: var(--chat-bg); box-shadow: var(--shadow); }
        @media (min-width: 1201px) { .app-container { height: 96vh; margin-top: 2vh; border-radius: 20px; border: 1px solid var(--border-color); overflow: hidden; } }
        
        /* ‰æßËæπÊ†è */
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 300px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transform: translateX(-100%); transition: var(--transition); z-index: 50; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 20px; }
        .sidebar.open { transform: translateX(0); }
        .overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); backdrop-filter: blur(2px); z-index: 40; }
        .overlay.show { display: block; }
        
        /* ÊêúÁ¥¢Ê°Ü */
        .search-box { position: relative; }
        .search-input { width: 100%; padding: 10px 36px 10px 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--chat-bg); color: var(--text-color); font-size: 14px; transition: all 0.2s; }
        .search-input:focus { border-color: var(--text-secondary); box-shadow: 0 0 0 2px rgba(100,116,139,0.1); }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); width: 16px; height: 16px; }
        
        /* Ê®°ÂºèÂàóË°® */
        .section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; padding-left: 4px; }
        
        .mode-list { display: grid; grid-template-columns: 1fr; gap: 6px; }
        .mode-card { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 10px; background: var(--chat-bg); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
        .mode-card:hover { border-color: var(--text-secondary); transform: translateY(-1px); }
        .mode-icon { font-size: 18px; width: 24px; text-align: center; }
        .mode-info div:first-child { font-size: 14px; font-weight: 500; }
        .mode-info div:last-child { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        
        /* ‰ºöËØùÂàÜÁªÑÂàóË°® */
        .session-group { margin-bottom: 20px; }
        .group-header { font-size: 11px; color: var(--text-secondary); margin: 0 0 6px 8px; font-weight: 600; }
        .session-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: space-between; color: var(--text-color); transition: background 0.2s; margin-bottom: 2px; }
        .session-item:hover { background: rgba(0,0,0,0.03); }
        [data-theme="dark"] .session-item:hover { background: rgba(255,255,255,0.03); }
        .session-item.active { background: var(--chat-bg); color: var(--text-color); font-weight: 600; border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .session-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 8px; display: flex; align-items: center; gap: 8px; }
        .session-actions { display: none; gap: 2px; }
        .session-item:hover .session-actions, .session-item.active .session-actions { display: flex; }
        
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border-color); display:flex; flex-direction:column; gap:8px;}
        .sidebar-btn { width: 100%; padding: 10px; border-radius: 8px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; font-weight: 500;}
        .btn-ghost { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); }
        .btn-ghost:hover { background: var(--bg-color); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger-color); border: 1px solid transparent; }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }

        /* ËÅäÂ§©‰∏ªÂå∫Âüü */
        .main-chat { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); position: relative; width: 100%; }
        .chat-header { padding: 0 20px; height: 64px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background-color: var(--chat-bg); z-index: 10; flex-shrink: 0; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px 0; display: flex; flex-direction: column; gap: 24px; scroll-behavior: smooth; }
        
        /* Ê∂àÊÅØÊ∞îÊ≥° */
        .message-row { display: flex; width: 100%; padding: 0 20px; gap: 12px; }
        .message-row.user { justify-content: flex-end; }
        
        .avatar { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
        .ai-avatar { background: var(--ai-msg-bg); border: 1px solid var(--border-color); }
        .user-avatar { background: var(--primary-color); color: var(--my-msg-text); order: 2; }
        
        .message-bubble { 
            max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 15px; line-height: 1.6; position: relative; 
            border: 1px solid transparent;
        }
        
        .message-row.user .message-bubble { 
            background: var(--my-msg-bg); color: var(--my-msg-text); 
            border-top-right-radius: 2px;
            order: 1;
        }
        
        .message-row.ai .message-bubble { 
            background: var(--ai-msg-bg); color: var(--ai-msg-text); 
            border-top-left-radius: 2px;
            border-color: var(--border-color);
        }
        
        /* Markdown Ê†∑Âºè */
        .message-bubble p { margin: 0 0 10px 0; }
        .message-bubble p:last-child { margin: 0; }
        .message-bubble pre { 
            background: #1e1e1e; color: #e2e8f0; 
            padding: 12px; border-radius: 8px; 
            overflow-x: auto; margin: 12px 0; 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 13px;
            border: 1px solid rgba(0,0,0,0.3);
        }
        .message-bubble code { 
            background: rgba(125, 125, 125, 0.2); 
            padding: 2px 5px; border-radius: 4px; 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.9em; 
        }
        .message-bubble pre code { background: transparent; padding: 0; color: inherit; }
        
        /* Ë°®Ê†º‰øÆÂ§ç */
        .message-bubble table { border-collapse: collapse; width: 100%; margin: 12px 0; display: block; overflow-x: auto; font-size: 14px;}
        .message-bubble th, .message-bubble td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; }
        .message-bubble th { background: rgba(0,0,0,0.03); font-weight: 600; }
        [data-theme="dark"] .message-bubble th { background: rgba(255,255,255,0.05); border-color: #334155; }
        [data-theme="dark"] .message-bubble td { border-color: #334155; }
        
        .message-bubble img { max-width: 100%; border-radius: 6px; margin-top: 8px; border: 1px solid var(--border-color); }

        .msg-meta { font-size: 10px; opacity: 0.5; margin-top: 4px; text-align: right; }

        /* ËæìÂÖ•Âå∫Âüü */
        .input-wrapper { padding: 16px 20px; background: var(--chat-bg); width: 100%; padding-bottom: max(16px, env(safe-area-inset-bottom)); flex-shrink: 0; }
        .input-box { display: flex; align-items: flex-end; gap: 8px; background: var(--bg-color); padding: 8px; border-radius: 12px; border: 1px solid var(--border-color); transition: border-color 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
        .input-box:focus-within { border-color: var(--text-secondary); }
        
        textarea { 
            flex: 1; background: transparent; border: none; outline: none; resize: none; 
            color: var(--text-color); font-size: 15px; max-height: 150px; overflow-y: auto; 
            padding: 10px 4px; line-height: 1.5; font-family: inherit;
        }

        .send-btn { 
            background: var(--text-color); color: var(--bg-color); 
            width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; 
        }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .send-btn svg { width: 18px; height: 18px; }

        #preview-area { display: flex; gap: 8px; padding-bottom: 8px; flex-wrap: wrap; }
        .preview-item { width: 48px; height: 48px; border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--border-color); display:flex; align-items:center; justify-content:center; background: var(--bg-color); }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-file { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.5); color: #fff; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; opacity: 0; cursor: pointer; transition: opacity 0.2s; }
        .preview-item:hover .remove-file { opacity: 1; }

        /* --- Admin & Modal Styles --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; }
        .modal.open { display: flex; }
        .modal-panel { background: var(--chat-bg); width: 95%; max-width: 800px; max-height: 85vh; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border-color); }
        
        /* ÊäòÂè†Èù¢ÊùøÊ†∑Âºè */
        .accordion-item { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; overflow: hidden; background: var(--bg-color); }
        .accordion-header { padding: 14px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 14px; background: var(--bg-color); transition: background 0.2s; }
        .accordion-header:hover { background: rgba(0,0,0,0.02); }
        .accordion-header i { transition: transform 0.2s; }
        .accordion-item.active .accordion-header i { transform: rotate(180deg); }
        .accordion-body { display: none; padding: 16px; border-top: 1px solid var(--border-color); background: var(--chat-bg); }
        .accordion-item.active .accordion-body { display: block; }

        /* ÂÖ¨ÂëäÂºπÁ™óÊ†∑Âºè */
        .announce-content { 
            line-height: 1.6; color: var(--text-color); font-size: 15px; 
            max-height: 60vh; overflow-y: auto; padding: 20px;
        }
        .announce-content h1, .announce-content h2 { margin-top: 10px; font-size: 1.2em; }
        .announce-content ul { padding-left: 20px; }
        
        @media (max-width: 768px) {
            .sidebar { width: 85%; max-width: 320px; }
            .chat-header { padding: 0 16px; height: 56px; }
            .input-wrapper { padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div class="login-title">üëÇüèªÈªéÂêßÂï¶AIüëÇüèª</div>
        <input type="text" id="loginUser" class="login-input" placeholder="Ë¥¶Âè∑">
        <input type="password" id="loginPass" class="login-input" placeholder="ÂØÜÁ†Å">
        <button class="login-btn" onclick="handleLogin()">ËøõÂÖ•Â∑•‰ΩúÂè∞</button>
    </div>
</div>

<!-- ÂÖ¨ÂëäÂºπÁ™ó -->
<div id="announceModal" class="modal">
    <div class="modal-panel" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;">üì¢ Á´ôÁÇπÂÖ¨Âëä</h3>
            <button class="icon-btn" onclick="document.getElementById('announceModal').classList.remove('open')"><i data-lucide="x"></i></button>
        </div>
        <div id="announceBody" class="announce-content"></div>
        <div style="padding:16px; border-top:1px solid var(--border-color); text-align:right;">
             <button class="login-btn" style="width:auto; padding:8px 24px;" onclick="closeAnnouncement()">Áü•ÈÅì‰∫Ü</button>
        </div>
    </div>
</div>

<!-- ÁÆ°ÁêÜÂêéÂè∞ -->
<div id="adminModal" class="modal">
    <div class="modal-panel">
        <div class="modal-header">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i data-lucide="settings-2"></i> ÁÆ°ÁêÜÂêéÂè∞</h3>
            <button class="icon-btn" onclick="document.getElementById('adminModal').classList.remove('open')"><i data-lucide="x"></i></button>
        </div>
        <div class="admin-body" style="flex:1; overflow-y:auto; padding:24px;">
            
            <!-- ÊäòÂè† 1: ÂèëÂ∏ÉÂÖ¨Âëä -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="megaphone"></i> ÂèëÂ∏ÉÊñ∞ÂÖ¨Âëä</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div style="margin-bottom:10px; font-size:13px; color:var(--text-secondary);">ÊîØÊåÅ Markdown Ê†ºÂºè„ÄÇÂèëÂ∏ÉÂêéÁî®Êà∑‰∏ãÊ¨°ÁôªÂΩïÊó∂ÂèØËßÅ„ÄÇ</div>
                    <textarea id="announceInput" class="login-input" style="height:100px; resize:vertical;" placeholder="ËØ∑ËæìÂÖ•ÂÖ¨ÂëäÂÜÖÂÆπ..."></textarea>
                    <div style="text-align:right;">
                        <button class="login-btn" style="width:auto; padding:8px 20px;" onclick="postAnnouncement()">ÂèëÂ∏ÉÂÖ¨Âëä</button>
                    </div>
                </div>
            </div>

            <!-- ÊäòÂè† 2: Êï∞ÊçÆÁªüËÆ° -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="bar-chart-3"></i> Ë∞ÉÁî®ÁªüËÆ°</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div id="statGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;"></div>
                </div>
            </div>
            
            <!-- ÊäòÂè† 3: Ê®°ÂûãÈ¢ÑËÆæ -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="cpu"></i> Ê®°ÂûãÈ¢ÑËÆæÁÆ°ÁêÜ</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div id="adminPresetList" style="margin-bottom:16px; display:flex; flex-direction:column; gap:8px;"></div>
                    
                    <div style="background:var(--bg-color); padding:16px; border-radius:8px; border:1px solid var(--border-color); margin-top:16px;">
                        <div style="font-weight:600; margin-bottom:12px; font-size:14px;" id="addFormTitle">Ê∑ªÂä†Êñ∞È¢ÑËÆæ</div>
                        <input type="hidden" id="addId">
                        <div style="display:grid; gap:12px;">
                            <input type="text" id="addName" class="login-input" style="margin:0" placeholder="ÊòæÁ§∫ÂêçÁß∞ (Â¶Ç: DeepSeek)">
                            <input type="text" id="addDesc" class="login-input" style="margin:0" placeholder="ÊèèËø∞">
                            <input type="text" id="addUrl" class="login-input" style="margin:0" placeholder="API Base URL">
                            <input type="text" id="addKey" class="login-input" style="margin:0" placeholder="API Key">
                            <input type="text" id="addModelId" class="login-input" style="margin:0" placeholder="Model ID">
                            <div style="display:flex; gap:12px;">
                                <button class="login-btn" style="flex:1;" onclick="savePreset()" id="savePresetBtn">‰øùÂ≠òÈÖçÁΩÆ</button>
                                <button class="btn-ghost" style="width:auto; padding:0 20px; border-radius:12px;" onclick="resetPresetForm()">ÈáçÁΩÆ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align:center; margin-top:20px;">
                <button class="btn-danger sidebar-btn" onclick="forceMigrate()" style="justify-content:center;">
                    <i data-lucide="database-backup"></i> ‰ªéÊóß database.json ÂØºÂÖ•Êï∞ÊçÆ
                </button>
            </div>
        </div>
    </div>
</div>

<div class="app-container" id="app">
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <!-- Search -->
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢..." oninput="handleSearch(this.value)">
                <i data-lucide="search" class="search-icon"></i>
            </div>

            <!-- Normal Content -->
            <div id="normalSidebarList" style="display:flex; flex-direction:column; gap:24px;">
                <div>
                    <div class="section-title">Êñ∞ÂØπËØù</div>
                    <div class="mode-list" id="presetList"></div>
                </div>
                
                <div>
                    <div class="section-title" style="display:flex; justify-content:space-between;">
                        <span>ÂéÜÂè≤ËÆ∞ÂΩï</span>
                        <span id="sessionCount" style="font-weight:normal;"></span>
                    </div>
                    <div id="sessionListContainer"></div>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResultList" style="display:none;">
                <div class="section-title">ÊêúÁ¥¢ÁªìÊûú</div>
                <div id="searchOutput" style="display:flex; flex-direction:column; gap:4px;"></div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button class="sidebar-btn btn-ghost" onclick="checkAnnouncement(true)">
                <i data-lucide="bell"></i> Êü•ÁúãÂÖ¨Âëä
            </button>
            <button id="adminBtn" onclick="openAdmin()" class="sidebar-btn btn-ghost" style="display:none;">
                <i data-lucide="settings"></i> ËÆæÁΩÆ
            </button>
            <button onclick="logout()" class="sidebar-btn btn-danger">
                <i data-lucide="log-out"></i> ÈÄÄÂá∫ÁôªÂΩï
            </button>
        </div>
    </div>

    <div class="main-chat">
        <header class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="icon-btn" onclick="toggleSidebar()" style="color:var(--text-color);">
                    <i data-lucide="menu"></i>
                </button>
                <div>
                    <div style="font-weight:600; font-size:16px; display:flex; align-items:center; color:var(--text-color);">
                        <span style="width:8px; height:8px; background:#10b981; border-radius:50%; margin-right:8px; display:inline-block;"></span>
                        <span id="headerTitle">AI Chat</span>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:4px;">
                <button class="icon-btn" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">
                    <i data-lucide="moon" id="themeIcon"></i>
                </button>
            </div>
        </header>
        
        <div id="chat-box"></div>
        
        <div class="input-wrapper">
            <div id="preview-area"></div>
            <div class="input-box">
                <input type="file" id="fileInput" accept="image/*,.json,.txt,.js,.md,.csv,.py" multiple style="display:none;" onchange="handleFileSelect(this)">
                <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="‰∏ä‰º†Êñá‰ª∂" style="align-self:flex-end; margin-bottom:2px;">
                    <i data-lucide="paperclip"></i>
                </button>
                <textarea id="userInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i data-lucide="arrow-up"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let PRESETS = []; 
    let currentSessionId = null;
    let isRequesting = false;
    let uploadedFiles = []; 
    let authToken = localStorage.getItem('authToken');
    let isAdmin = localStorage.getItem('isAdmin') === 'true';

    marked.setOptions({
        highlight: function(code, lang) {
            const language = highlight.getLanguage(lang) ? lang : 'plaintext';
            return highlight.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-', breaks: true, gfm: true
    });

    window.onload = function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        lucide.createIcons();
        if (authToken) initApp();
        document.getElementById('userInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey && !isTouchDevice()) { e.preventDefault(); sendMessage(); }
        });
        window.addEventListener('paste', handlePaste);
    };

    function isTouchDevice() { return 'ontouchstart' in window || navigator.maxTouchPoints > 0; }

    async function handleLogin() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        try {
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p }) });
            const data = await res.json();
            if (data.success) {
                authToken = data.token; isAdmin = data.isAdmin;
                localStorage.setItem('authToken', authToken); localStorage.setItem('isAdmin', isAdmin);
                initApp();
            } else { alert(data.message); }
        } catch(e) { alert("ÁΩëÁªúÈîôËØØ"); }
    }

    function logout() { localStorage.removeItem('authToken'); localStorage.removeItem('isAdmin'); location.reload(); }

    async function initApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        if(isAdmin) document.getElementById('adminBtn').style.display = 'flex';
        await fetchPresets(); await fetchSessions(); 
        lucide.createIcons();
        checkAnnouncement(false); // Check for new announcement
    }

    // --- ÂÖ¨ÂëäÁ≥ªÁªü ---
    let currentAnnounceTime = 0;

    async function checkAnnouncement(forceShow) {
        try {
            const res = await fetch('/api/announcement', { headers: { 'Authorization': `Bearer ${authToken}` } });
            const json = await res.json();
            if (json.success && json.data) {
                const { content, timestamp } = json.data;
                currentAnnounceTime = timestamp;
                const lastRead = localStorage.getItem('lastReadAnnounce');
                
                // Â¶ÇÊûúÂº∫Âà∂ÊòæÁ§∫(ÁÇπÂáªÊåâÈíÆ)ÔºåÊàñËÄÖËØ•ÂÖ¨ÂëäÊØîÁî®Êà∑‰∏äÊ¨°ËØªÁöÑË¶ÅÊñ∞
                if (forceShow || (!lastRead || parseInt(lastRead) < timestamp)) {
                    document.getElementById('announceBody').innerHTML = DOMPurify.sanitize(marked.parse(content));
                    document.getElementById('announceModal').classList.add('open');
                }
            } else if (forceShow) {
                alert("ÊöÇÊó†ÂÖ¨Âëä");
            }
        } catch(e) { console.error(e); }
    }

    function closeAnnouncement() {
        document.getElementById('announceModal').classList.remove('open');
        // ËÆ∞ÂΩïÂ∑≤ËØªÊó∂Èó¥
        if (currentAnnounceTime > 0) {
            localStorage.setItem('lastReadAnnounce', currentAnnounceTime);
        }
    }

    async function postAnnouncement() {
        const content = document.getElementById('announceInput').value;
        if (!content.trim()) return alert("ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫");
        if (!confirm("Á°ÆÂÆöÂèëÂ∏ÉÊ≠§ÂÖ¨ÂëäÂêóÔºüÊâÄÊúâÁî®Êà∑‰∏ãÊ¨°ÁôªÂΩïÂ∞ÜÁúãÂà∞„ÄÇ")) return;
        
        await fetch('/api/admin/announcement', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ content })
        });
        alert("ÂèëÂ∏ÉÊàêÂäü");
        document.getElementById('announceInput').value = '';
    }

    // --- ÊäòÂè†Èù¢ÊùøÈÄªËæë ---
    function toggleAccordion(header) {
        const item = header.parentElement;
        // ÂÖ≥Èó≠ÂÖ∂‰ªñ
        // document.querySelectorAll('.accordion-item').forEach(i => { if(i!==item) i.classList.remove('active'); });
        item.classList.toggle('active');
    }

    // --- ÂéüÊúâÈÄªËæë ---
    let searchTimeout;
    async function handleSearch(query) {
        clearTimeout(searchTimeout);
        const normalList = document.getElementById('normalSidebarList');
        const searchList = document.getElementById('searchResultList');
        const output = document.getElementById('searchOutput');
        
        if (!query.trim()) {
            normalList.style.display = 'flex';
            searchList.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(async () => {
            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const json = await res.json();
                if (json.success) {
                    normalList.style.display = 'none';
                    searchList.style.display = 'block';
                    output.innerHTML = '';
                    if (json.data.length === 0) {
                        output.innerHTML = '<div style="padding:10px; color:var(--text-secondary); text-align:center; font-size:14px;">Êó†Áõ∏ÂÖ≥ËÆ∞ÂΩï</div>';
                        return;
                    }
                    json.data.forEach(item => {
                        const preview = item.content.length > 30 ? item.content.substring(0, 30) + '...' : item.content;
                        output.innerHTML += `
                            <div class="session-item" onclick="loadSession('${item.session_id}')">
                                <div>
                                    <div style="font-weight:600;">${item.session_title}</div>
                                    <div style="font-size:12px; color:var(--text-secondary); margin-top:2px;">${preview}</div>
                                </div>
                            </div>`;
                    });
                }
            } catch(e) {}
        }, 300); 
    }

    function getDateLabel(ts) {
        const d = new Date(ts);
        const now = new Date();
        const diff = now - d;
        const oneDay = 24 * 60 * 60 * 1000;
        
        if (d.toDateString() === now.toDateString()) return '‰ªäÂ§©';
        if (diff < oneDay * 2 && d.getDate() !== now.getDate()) return 'Êò®Â§©';
        if (diff < oneDay * 7) return '7Â§©ÂÜÖ';
        return 'Êõ¥Êó©';
    }

    async function fetchSessions() {
        try {
            const res = await fetch('/api/sessions', { headers: { 'Authorization': `Bearer ${authToken}` } });
            const json = await res.json();
            if (json.success) {
                const container = document.getElementById('sessionListContainer');
                container.innerHTML = '';
                document.getElementById('sessionCount').innerText = `${json.data.length}`;
                
                const groups = { '‰ªäÂ§©': [], 'Êò®Â§©': [], '7Â§©ÂÜÖ': [], 'Êõ¥Êó©': [] };
                json.data.forEach(s => {
                    const label = getDateLabel(s.updated_at);
                    if (groups[label]) groups[label].push(s);
                    else groups['Êõ¥Êó©'].push(s);
                });

                const groupOrder = ['‰ªäÂ§©', 'Êò®Â§©', '7Â§©ÂÜÖ', 'Êõ¥Êó©'];
                
                groupOrder.forEach(label => {
                    if (groups[label].length > 0) {
                        let html = `<div class="session-group"><div class="group-header">${label}</div>`;
                        groups[label].forEach(s => {
                            const preset = PRESETS.find(p => p.id === s.mode);
                            const active = s.id === currentSessionId ? 'active' : '';
                            html += `
                                <div class="session-item ${active}" onclick="loadSession('${s.id}')">
                                    <div class="session-title">
                                        <span style="font-size:16px;">${preset?preset.icon:''}</span> 
                                        <span>${s.title}</span>
                                    </div>
                                    <div class="session-actions">
                                        <button class="icon-btn" style="padding:4px;" onclick="renameSession('${s.id}', '${s.title}'); event.stopPropagation();"><i data-lucide="edit-2" style="width:14px; height:14px;"></i></button>
                                        <button class="icon-btn" style="padding:4px; color:var(--danger-color);" onclick="deleteSession('${s.id}'); event.stopPropagation();"><i data-lucide="trash-2" style="width:14px; height:14px;"></i></button>
                                    </div>
                                </div>`;
                        });
                        html += `</div>`;
                        container.innerHTML += html;
                    }
                });

                if (!currentSessionId && json.data.length > 0) loadSession(json.data[0].id);
                lucide.createIcons();
            }
        } catch(e) {}
    }

    async function loadSession(id) {
        if(isRequesting) return;
        currentSessionId = id;
        document.getElementById('searchInput').value = '';
        document.getElementById('normalSidebarList').style.display = 'flex';
        document.getElementById('searchResultList').style.display = 'none';

        document.getElementById('chat-box').innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary);">Âä†ËΩΩ‰∏≠...</div>';
        try {
            const res = await fetch(`/api/session/${id}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const json = await res.json();
            if (json.success) {
                document.getElementById('headerTitle').innerText = json.session.title;
                const box = document.getElementById('chat-box'); box.innerHTML = '';
                if (json.messages.length === 0) box.innerHTML = '<div style="text-align:center; padding:80px; color:var(--text-secondary);"><i data-lucide="message-square-plus" style="width:48px;height:48px;opacity:0.2;margin-bottom:16px;"></i><br>ÂºÄÂßãÊñ∞ÁöÑÂØπËØù</div>';
                
                json.messages.forEach(msg => {
                    let text = ""; let imgs = [];
                    if (typeof msg.content === 'string') text = msg.content;
                    else {
                        msg.content.forEach(c => { if (c.type === 'text') text += c.text; if (c.type === 'image_url') imgs.push(c.image_url.url); });
                    }
                    appendUI(null, msg.role, text, imgs, false, msg.timestamp);
                });
                
                fetchSessions(); // Update Active State
                lucide.createIcons();
                if(window.innerWidth < 1000) { document.getElementById('sidebar').classList.remove('open'); document.querySelector('.overlay').classList.remove('show'); }
            }
        } catch(e) { document.getElementById('chat-box').innerHTML = "Âä†ËΩΩÂ§±Ë¥•"; }
    }

    async function createNewSession(presetId) {
        const res = await fetch('/api/session/new', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ presetId }) });
        const json = await res.json();
        if (json.success) { await fetchSessions(); loadSession(json.id); }
    }

    async function renameSession(id, oldTitle) {
        const t = prompt("Êñ∞Ê†áÈ¢ò", oldTitle);
        if (t && t !== oldTitle) {
            await fetch('/api/session/rename', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ id, title: t }) });
            fetchSessions();
            if(currentSessionId === id) document.getElementById('headerTitle').innerText = t;
        }
    }

    async function deleteSession(id) {
        if (!confirm("Á°ÆÂÆöÂà†Èô§?")) return;
        await fetch('/api/session/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ id }) });
        if(currentSessionId === id) { currentSessionId = null; document.getElementById('chat-box').innerHTML = ''; document.getElementById('headerTitle').innerText = 'AI Chat'; }
        fetchSessions();
    }

    async function sendMessage() {
        if (isRequesting || !currentSessionId) return;
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text && uploadedFiles.length === 0) return;
        
        let payload = [];
        uploadedFiles.forEach(f => {
            if (f.type.startsWith('image/')) payload.push({ type: "image_url", image_url: { url: f.data } });
            else payload.push({ type: "text", text: `[Êñá‰ª∂ ${f.name}]:\n${f.data}\n` });
        });
        if (text) payload.push({ type: "text", text });

        appendUI(null, "user", text + (uploadedFiles.length > 0 ? `\n(üìé ${uploadedFiles.length} ÈôÑ‰ª∂)` : ""), uploadedFiles.filter(f=>f.type.startsWith('image/')).map(f=>f.data), false, Date.now());
        
        input.value = ''; uploadedFiles = []; renderPreviews(); autoResize(input);
        isRequesting = true;
        const sendBtn = document.getElementById('sendBtn'); sendBtn.disabled = true;

        const aiMsgId = appendUI(null, "ai", "", [], true); 
        const aiContentDiv = document.querySelector(`#${aiMsgId} .message-content`);
        let aiFullText = "";

        try {
            const sessRes = await fetch(`/api/session/${currentSessionId}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
            const sessData = await sessRes.json();
            let msgs = sessData.messages || [];
            
            const cleanMsgs = msgs.map(m => ({ role: m.role, content: m.content }));
            cleanMsgs.push({ role: "user", content: payload });

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify({ sessionId: currentSessionId, presetId: sessData.session.mode, messages: cleanMsgs })
            });

            if (!response.ok) throw new Error("API Error");

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.trim() === '') continue;
                    if (line.startsWith('data: ')) {
                         const dataStr = line.slice(6).trim();
                         if (dataStr === '[DONE]') continue;
                         try {
                             const json = JSON.parse(dataStr);
                             if (json.error) throw new Error(json.error.message);
                             const delta = json.choices?.[0]?.delta?.content || "";
                             aiFullText += delta;
                         } catch (e) { }
                    } else {
                        try {
                           const json = JSON.parse(line);
                           if(json.choices) aiFullText += (json.choices[0].delta?.content || "");
                        } catch(e) {}
                    }
                }

                aiContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(aiFullText));
                const chatBox = document.getElementById('chat-box');
                if(chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 200) {
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
            
            aiContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(aiFullText));
            // Add meta info
            const metaDiv = document.createElement('div');
            metaDiv.className = 'msg-meta';
            metaDiv.innerText = formatTime(Date.now());
            document.getElementById(aiMsgId).querySelector('.message-bubble').appendChild(metaDiv);
            
            fetchSessions(); 

        } catch (e) {
            aiContentDiv.innerHTML += `<br><span style="color:var(--danger-color)">Error: ${e.message}</span>`;
        } finally {
            isRequesting = false; sendBtn.disabled = false;
        }
    }

    function formatTime(ts) {
        if (!ts) return '';
        const date = new Date(ts);
        return `${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
    }

    function appendUI(id, role, text, images = [], isLoading = false, timestamp = null) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message-row ${role === 'user' ? 'user' : 'ai'}`;
        div.id = id || ('msg-' + Date.now());
        
        let contentHtml = "";
        if (role === 'user') {
            if (images && images.length > 0) images.forEach(u => contentHtml += `<img src="${u}"><br>`);
            contentHtml += text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        } else {
            if (isLoading) contentHtml = `<span style="color:var(--text-secondary)">Thinking...</span>`;
            else contentHtml = DOMPurify.sanitize(marked.parse(text));
        }
        
        const avatarIcon = role === 'user' ? 'user' : 'bot';
        
        let html = `
            <div class="avatar ${role === 'user' ? 'user-avatar' : 'ai-avatar'}">
                <i data-lucide="${avatarIcon}" style="width:18px; height:18px;"></i>
            </div>
            <div class="message-bubble">
                <div class="message-content">${contentHtml}</div>
                ${(timestamp && !isLoading) ? `<div class="msg-meta">${formatTime(timestamp)}</div>` : ''}
            </div>
        `;
        
        div.innerHTML = html;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        lucide.createIcons({ root: div }); 
        return div.id;
    }

    function handlePaste(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) { if (item.kind === 'file') processFile(item.getAsFile()); }
    }
    function handleFileSelect(input) { if (input.files.length) Array.from(input.files).forEach(processFile); input.value = ''; }
    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => { uploadedFiles.push({ name: file.name, type: file.type, data: e.target.result }); renderPreviews(); };
        if (file.type.startsWith('image/')) reader.readAsDataURL(file); else reader.readAsText(file);
    }
    function renderPreviews() {
        const area = document.getElementById('preview-area'); area.innerHTML = '';
        uploadedFiles.forEach((f, i) => {
            area.innerHTML += `
            <div class="preview-item">
                ${f.type.startsWith('image/') ? `<img src="${f.data}">` : '<i data-lucide="file-text" style="color:var(--text-secondary)"></i>'}
                <div class="remove-file" onclick="uploadedFiles.splice(${i},1);renderPreviews()"><i data-lucide="x" style="width:14px"></i></div>
            </div>`;
        });
        lucide.createIcons();
    }
    
    function autoResize(el) { el.style.height = 'auto'; el.style.height = (el.scrollHeight) + 'px'; }

    // --- Admin ---
    async function fetchPresets() {
        try { const res = await fetch('/api/config'); const data = await res.json(); if(data.success) { PRESETS = data.presets; renderPresetsSidebar(); } } catch(e){}
    }
    function renderPresetsSidebar() {
        const list = document.getElementById('presetList'); list.innerHTML = '';
        PRESETS.forEach(p => {
            list.innerHTML += `
            <div class="mode-card" onclick="createNewSession('${p.id}')">
                <div class="mode-icon">${p.icon||'‚ö°'}</div>
                <div class="mode-info">
                    <div>${p.name}</div>
                    <div>${p.desc}</div>
                </div>
            </div>`;
        });
    }

    async function openAdmin() {
        document.getElementById('adminModal').classList.add('open');
        const res = await fetch('/api/admin/data', { headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        
        const grid = document.getElementById('statGrid'); grid.innerHTML = '';
        if (data.usage) {
            for (const [user, usage] of Object.entries(data.usage)) {
                let total = 0; let listHtml = '';
                for (const [mid, count] of Object.entries(usage)) {
                    total += count;
                    const preset = PRESETS.find(p => p.id === mid);
                    const displayName = preset ? `${preset.icon} ${preset.name}` : `<span style="color:var(--text-secondary);font-style:italic;">${mid}</span>`;
                    listHtml += `<div style="display:flex;justify-content:space-between;font-size:13px;padding:4px 0;border-bottom:1px dashed var(--border-color);"><span>${displayName}</span><span style="font-weight:600;">${count}</span></div>`;
                }
                grid.innerHTML += `<div style="background:var(--bg-color);border:1px solid var(--border-color);padding:16px;border-radius:12px;"><div style="font-weight:600;margin-bottom:12px;display:flex;justify-content:space-between;"><span>üë§ ${user}</span><span style="background:var(--primary-color);color:var(--my-msg-text);padding:2px 8px;border-radius:10px;font-size:12px;">${total}</span></div><div>${listHtml}</div></div>`;
            }
        }

        const pList = document.getElementById('adminPresetList'); pList.innerHTML = '';
        data.presets.forEach(p => {
            const presetJson = JSON.stringify(p).replace(/"/g, '&quot;');
            pList.innerHTML += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-color);border:1px solid var(--border-color);border-radius:8px;">
                    <div><strong style="margin-right:8px;">${p.name}</strong> <span style="font-size:12px;color:var(--text-secondary);">${p.modelId}</span></div>
                    <div style="display:flex;gap:4px;">
                        <button class="icon-btn" onclick="editPreset('${presetJson}')"><i data-lucide="edit-3" style="width:16px;"></i></button>
                        <button class="icon-btn" style="color:var(--danger-color);" onclick="deletePreset('${p.id}')"><i data-lucide="trash-2" style="width:16px;"></i></button>
                    </div>
                </div>`;
        });
        lucide.createIcons();
    }

    function editPreset(jsonStr) {
        const p = JSON.parse(jsonStr);
        document.getElementById('addId').value = p.id;
        document.getElementById('addName').value = p.name;
        document.getElementById('addDesc').value = p.desc;
        document.getElementById('addUrl').value = p.url;
        document.getElementById('addKey').value = p.key;
        document.getElementById('addModelId').value = p.modelId;
        document.getElementById('addFormTitle').innerText = "ÁºñËæëÈ¢ÑËÆæ: " + p.name;
        document.getElementById('savePresetBtn').innerText = "‰øùÂ≠ò";
        
        // Auto expand preset accordion
        const accordions = document.querySelectorAll('.accordion-item');
        if (accordions.length > 2) {
             accordions.forEach(i => i.classList.remove('active'));
             accordions[2].classList.add('active'); // Open preset panel
        }
    }

    function resetPresetForm() {
        document.getElementById('addId').value = '';
        document.querySelectorAll('#adminModal input[type="text"]').forEach(i => i.value = '');
        document.getElementById('addFormTitle').innerText = "Ê∑ªÂä†Êñ∞È¢ÑËÆæ";
        document.getElementById('savePresetBtn').innerText = "‰øùÂ≠ò";
    }

    async function savePreset() {
        const id = document.getElementById('addId').value;
        const name = document.getElementById('addName').value;
        const url = document.getElementById('addUrl').value;
        const key = document.getElementById('addKey').value;
        const modelId = document.getElementById('addModelId').value;
        const desc = document.getElementById('addDesc').value;
        if(!name || !url || !key || !modelId) return alert("ËØ∑Â°´ÂÜôÂÆåÊï¥");
        await fetch('/api/admin/preset', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ id, name, url, key, modelId, desc }) });
        alert("‰øùÂ≠òÊàêÂäü"); resetPresetForm(); openAdmin(); fetchPresets();
    }

    async function deletePreset(id) {
        if(!confirm("Á°ÆÂÆöÂà†Èô§Ê≠§È¢ÑËÆæÂêóÔºü")) return;
        await fetch('/api/admin/preset/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }, body: JSON.stringify({ id }) });
        openAdmin(); fetchPresets();
    }

    async function forceMigrate() {
        if(!confirm("‚ö†Ô∏è Á°ÆÂÆöË¶Å‰ªéÊóßÁöÑ database.json ÂØºÂÖ•Êï∞ÊçÆÂêóÔºü")) return;
        try {
            const res = await fetch('/api/admin/migrate', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}` } });
            const json = await res.json();
            alert(json.message); location.reload();
        } catch(e) { alert("ÂØºÂÖ•Â§±Ë¥•: " + e.message); }
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('show'); }
    function toggleTheme() { 
        const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; 
        document.documentElement.setAttribute('data-theme', n); 
        localStorage.setItem('theme', n);
        lucide.createIcons();
    }
</script>
</body>
</html>


