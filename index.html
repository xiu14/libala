<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Workspace</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div class="login-title">👂🏻黎吧啦AI👂🏻</div>
        <input type="text" id="loginUser" class="login-input" placeholder="账号">
        <input type="password" id="loginPass" class="login-input" placeholder="密码">
        <button class="login-btn" onclick="handleLogin()">进入工作台</button>
    </div>
</div>

<!-- 公告弹窗 -->
<div id="announceModal" class="modal">
    <div class="modal-panel" style="max-width: 500px;">
        <div class="modal-header">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;">📢 站点公告</h3>
            <button class="icon-btn" onclick="document.getElementById('announceModal').classList.remove('open')"><i data-lucide="x"></i></button>
        </div>
        <div id="announceBody" class="announce-content"></div>
        <div style="padding:16px; border-top:1px solid var(--border-color); text-align:right;">
             <button class="login-btn" style="width:auto; padding:8px 24px;" onclick="closeAnnouncement()">知道了</button>
        </div>
    </div>
</div>

<!-- 管理后台 -->
<div id="adminModal" class="modal">
    <div class="modal-panel">
        <div class="modal-header">
            <h3 style="margin:0; display:flex; align-items:center; gap:8px;"><i data-lucide="settings-2"></i> 管理后台</h3>
            <button class="icon-btn" onclick="document.getElementById('adminModal').classList.remove('open')"><i data-lucide="x"></i></button>
        </div>
        <div class="admin-body" style="flex:1; overflow-y:auto; padding:24px;">
            
            <!-- 折叠 1: 公告管理 -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this); fetchAdminAnnouncements();">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="megaphone"></i> 公告管理</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <textarea id="announceInput" class="login-input" style="height:80px; resize:vertical;" placeholder="发布新公告 (自动追加当前时间)"></textarea>
                    <div style="text-align:right; margin-bottom:16px;">
                        <button class="login-btn" style="width:auto; padding:8px 20px;" onclick="postAnnouncement()">发布</button>
                    </div>
                    <div style="border-top:1px solid var(--border-color); padding-top:12px;">
                        <div style="font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:8px;">历史公告</div>
                        <div id="adminAnnounceList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    </div>
                </div>
            </div>

            <!-- 折叠 2: 数据统计 -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="bar-chart-3"></i> 调用统计</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div id="statGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;"></div>
                </div>
            </div>
            
            <!-- 折叠 3: 模型预设 -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span style="display:flex;align-items:center;gap:8px;"><i data-lucide="cpu"></i> 模型预设管理</span>
                    <i data-lucide="chevron-down"></i>
                </div>
                <div class="accordion-body">
                    <div id="adminPresetList" style="margin-bottom:16px; display:flex; flex-direction:column; gap:8px;"></div>
                    <div style="background:var(--bg-color); padding:16px; border-radius:8px; border:1px solid var(--border-color); margin-top:16px;">
                        <div style="font-weight:600; margin-bottom:12px; font-size:14px;" id="addFormTitle">添加新预设</div>
                        <input type="hidden" id="addId">
                        <div style="display:grid; gap:12px;">
                            <input type="text" id="addName" class="login-input" style="margin:0" placeholder="显示名称">
                            <input type="text" id="addDesc" class="login-input" style="margin:0" placeholder="描述">
                            <input type="text" id="addUrl" class="login-input" style="margin:0" placeholder="API Base URL">
                            <input type="text" id="addKey" class="login-input" style="margin:0" placeholder="API Key">
                            <input type="text" id="addModelId" class="login-input" style="margin:0" placeholder="Model ID">
                            <div style="display:flex; gap:12px;">
                                <button class="login-btn" style="flex:1;" onclick="savePreset()" id="savePresetBtn">保存配置</button>
                                <button class="btn-ghost" style="width:auto; padding:0 20px; border-radius:12px;" onclick="resetPresetForm()">重置</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align:center; margin-top:20px;">
                <button class="btn-danger sidebar-btn" onclick="forceMigrate()" style="justify-content:center;">
                    <i data-lucide="database-backup"></i> 从旧数据导入
                </button>
            </div>
        </div>
    </div>
</div>

<div class="app-container" id="app">
    <div class="overlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="搜索..." oninput="handleSearch(this.value)">
                <i data-lucide="search" class="search-icon"></i>
            </div>
            <div id="normalSidebarList" style="display:flex; flex-direction:column; gap:24px;">
                <div><div class="section-title">新对话</div><div class="mode-list" id="presetList"></div></div>
                <div>
                    <div class="section-title" style="display:flex; justify-content:space-between;"><span>历史记录</span><span id="sessionCount" style="font-weight:normal;"></span></div>
                    <div id="sessionListContainer"></div>
                </div>
            </div>
            <div id="searchResultList" style="display:none;">
                <div class="section-title">搜索结果</div>
                <div id="searchOutput" style="display:flex; flex-direction:column; gap:4px;"></div>
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="sidebar-btn btn-ghost" onclick="checkAnnouncement(true)"><i data-lucide="bell"></i> 查看公告</button>
            <button id="adminBtn" onclick="openAdmin()" class="sidebar-btn btn-ghost" style="display:none;"><i data-lucide="settings"></i> 设置</button>
            <button onclick="logout()" class="sidebar-btn btn-danger"><i data-lucide="log-out"></i> 退出登录</button>
        </div>
    </div>

    <div class="main-chat">
        <header class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <button class="icon-btn" onclick="toggleSidebar()" style="color:var(--text-color);"><i data-lucide="menu"></i></button>
                <div style="font-weight:600; font-size:16px; display:flex; align-items:center; color:var(--text-color);">
                    <span style="width:8px; height:8px; background:#10b981; border-radius:50%; margin-right:8px; display:inline-block;"></span>
                    <span id="headerTitle">AI Chat</span>
                </div>
            </div>
            <div style="display:flex; gap:4px;">
                <button class="icon-btn" onclick="toggleTheme()"><i data-lucide="moon" id="themeIcon"></i></button>
            </div>
        </header>
        
        <div id="chat-box"></div>
        
        <div class="input-wrapper">
            <div id="preview-area"></div>
            <div class="input-box">
                <input type="file" id="fileInput" accept="image/*,.json,.txt,.js,.md,.csv,.py" multiple style="display:none;" onchange="handleFileSelect(this)">
                
                <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="上传文件" style="align-self:flex-end; margin-bottom:2px;">
                    <i data-lucide="paperclip"></i>
                </button>
                <!-- 新增：搜索开关 -->
                <button class="icon-btn" id="searchToggleBtn" onclick="toggleSearch()" title="开启联网搜索" style="align-self:flex-end; margin-bottom:2px;">
                    <i data-lucide="globe"></i>
                </button>

                <textarea id="userInput" placeholder="输入消息..." rows="1" oninput="autoResize(this)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i data-lucide="arrow-up"></i>
                </button>
            </div>
        </div>
    </div>
</div>
<script src="app.js"></script>
</body>
</html>
